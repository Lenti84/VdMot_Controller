<!DOCTYPE html>

<html>
<head>
<link rel="icon" href="data:,">
<link rel="icon" href="../favicon.ico">
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
	body {
	  font-family: sans-serif;
	  margin:0;
	}
	/* Add a black background color to the top navigation */
	.topNav {
		background-color: #333;
		overflow: hidden;
	}

	/* Style the links inside the navigation bar */
	.topNav a {
		float: left;
		display: block;
		color: #f2f2f2;
		text-align: center;
		padding: 14px 16px;
		text-decoration: none;
		font-size: 17px;
	}

	/* Change the color of links on hover */
	.topNav a:hover {
		background-color: #ddd;
		color: black;
	}

	/* Hide the link that should open and close the topNav on small screens */
	.topNav .icon {
		display: none;
	}

	/* When the screen is less than 600 pixels wide, hide all links, except for the first one ("Home"). Show the link that contains should open and close the topNav (.icon) */
	@media screen and (max-width: 600px) {
	  .topNav a:not(:first-child) {display: none;}
	  .topNav a.icon {
		float: right;
		display: block;
	  }
	}

	/* The "responsive" class is added to the topNav with JavaScript when the user clicks on the icon. This class makes the topNav look good on small screens (display the links vertically instead of horizontally) */
	@media screen and (max-width: 600px) {
	  .topNav.responsive {position: relative;}
	  .topNav.responsive a.icon {
		position: absolute;
		right: 0;
		top: 0;
	  }
	  .topNav.responsive a {
		float: none;
		display: block;
		text-align: left;
	  }
	}
	
	/* Style the tab content (and add height:100% for full page content) */
	.tabContent {
	  color: white;
	  display: none;
	  padding: 10px 20px;
	  height:100%;
	}
	
	/* Style tab links */
	.tabLink {
	  background-color: #555;
	  color: white;
	  float: left;
	  border: none;
	  outline: none;
	  cursor: pointer;
	  padding: 14px 16px;
	  font-size: 17px;
	  width: 12%;
	}

	.tabLink:hover {
	  background-color: #777;
	}

	.tabLink:hover {
	  background-color: #777;
	}
	
	.tabframe {
	  border: white 2px solid;
	  padding: 5px;
	  border-radius: 5px;
	  text-align: center;
	}
	
	.tabiframe {
	  border-top: white 1px solid;
	  padding: 5px;
	  text-align: center;
	}
	.tabpframe {
	  border-top: white 1px solid;
	  padding: 5px;
	  text-align: center;
	}
	
	.form-input{
		width: 100px;
	}
	.form-input1{
		width: 300px;
	}
	.form-input2{
		width: 250px;
	}
	form-input3{
		width: 50px;
		margin-left: 5px;
	}
	.rtabframe {
		border: white 2px solid;
		padding: 5px;
		border-radius: 5px;
		text-align: center;
	}
	.rtabframe2 {
		border: white 2px solid;
		padding: 5px;
		border-radius: 5px;
		text-align: center;
		grid-column : span 2;
	}
	
	.rtabframe3 {
		border: white 2px solid;
		padding: 5px;
		border-radius: 5px;
		text-align: center;
		grid-column : span 3;
	}

	.rtabframe4 {
		border: white 2px solid;
		padding: 5px;
		border-radius: 5px;
		text-align: center;
		grid-column : span 4;
	}
	
	.alignTabCellState{
	 float: center;
	 padding-top: 10px;
	}

	.alignTabCellImgState{
	 float: left;
	 padding: 5px 2px;
	}

	table.tabTable {
		width : 100%
	}

	table.tabTable td {
		padding-left: 5px;
		height:21px;
	}

	table.tabTable1 {
		width : 100%
	}
	
	table.tabTable1 td {
		padding-left: 5px;
		height:21px;
		text-align: center;
		width : 200px;
	}
	
	table.tabTable1 th {
		padding-left: 5px;
		height:21px;
		text-align: center;
		width : 140px;
	}
	
	.hide {
		display: none;
	}
	
	.show {
		display: block;
		text-align: center;
		padding-left: 5px;
	}

	.collapse {
		visibility: collapse;
	}
	
   .buttonclass:hover {
		padding: 0.6em;
		font-weight: bold;
		background-color: #fff;
		color: green;
	}

	.buttonclass {
		font-weight: bold;
		background-color: #79B935;
		color: #fff;
		margin: 2px;
		padding: 0.6em;
		border-radius: 5px;

	}
	.buttonclass:disabled {
		font-weight: bold;
		background-color: #79B900;
		color: #c0c0c0;
	}

	.buttonclass1:hover {
		padding: 0.6em;
		font-weight: bold;
		background-color: #fff;
		color: green;
	}

	.buttonclass1 {
		font-weight: bold;
		background-color: #79B935;
		color: #fff;
		margin: 2px;
		padding: 0.6em;
		border-radius: 5px;
		float: right;

	}
	.buttonclass1:disabled {
		font-weight: bold;
		background-color: #79B900;
		color: #c0c0c0;
	}
	
	.dialogClass{
		width: 30em;
		overflow-y: auto;
		text-align: left;	
		border: lightgray 5px solid;
	}
	.checkboxgroup{
		width: 11em;
		height : 12em;
		overflow-y: auto;
		text-align: left;
	}
	.checkboxgroup p{
		width: 10em;
		text-align: left;
	}
	.checkboxgroup label{
		width: 10em;
		float: left;
	}

	.checkboxgroup1{
		width: 16em;
		height : 12em;
		overflow-y: auto;
		text-align: left;
	}
	.checkboxgroup1 p{
		width: 16em;
		text-align: left;
	}
	.checkboxgroup1 label{
		width: 16em;
		float: left;
	}

	.checkboxgroup2{
		width: 15em;
		height : 12em;
		overflow-y: auto;
		text-align: left;
	}
	.checkboxgroup2 p{
		width: 15em;
		text-align: left;
	}
	.checkboxgroup2 label{
		width: 15em;
		float: left;
	}

	/* The Modal (background) */
	.modal {
	  display: none; /* Hidden by default */
	  position: fixed; /* Stay in place */
	  z-index: 1; /* Sit on top */
	  padding-top: 100px; /* Location of the box */
	  left: 0;
	  top: 0;
	  width: 100%; /* Full width */
	  height: 100%; /* Full height */
	  overflow: auto; /* Enable scroll if needed */
	  background-color: rgb(0,0,0); /* Fallback color */
	  background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
	}

	/* Modal Content */
	.modal-content {
	  background-color: #fefefe;
	  margin: auto;
	  padding: 20px;
	  border: 1px solid #888;
	  width: 80%;
	}

	/* The Close Button */
	.close {
	  color: #aaaaaa;
	  float: right;
	  font-size: 28px;
	  font-weight: bold;
	}

	.close:hover,
	.close:focus {
	  color: #000;
	  text-decoration: none;
	  cursor: pointer;
	}
	
   .container {  
		display: grid;  
		grid-gap: 2px;  
		grid-template-columns: repeat(auto-fit, minmax(285px, 1fr)); 
		grid-template-rows:  masonry;
	}
	
	.container1 {  
		display: grid;  
		grid-gap: 2px;  
		grid-template-columns: repeat(auto-fit, 350px);
		grid-template-rows:  masonry;
	}
	
	.container2 {  
		display: grid;  
		grid-gap: 2px;  
		grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
		grid-template-rows:  masonry;
	}
	
	.container3 {  
		display: grid;  
		grid-gap: 2px;  
		grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
		grid-template-rows:  masonry;
	}
		
	div[disabled]
	{
		pointer-events: none;     
		opacity: 0.4;
	}

	/* slider checkbox */ 
	[type="checkbox"] {
	--s:18px; /* adjust this to control the size*/
	position: relative; 
  	top: .3em;
	height:var(--s);
	aspect-ratio:2/1;
	padding:calc(var(--s)/5);
	border-radius:var(--s);
	background:
		radial-gradient(farthest-side,#fafafa 85%,#0005,#0000) left/var(--s) 100% no-repeat,
		/*linear-gradient(90deg,#20b68f 50%,#939393 0) right/200% 100% content-box;*/
		linear-gradient(90deg,#79B935 50%,#939393 0) right/200% 100% content-box;
	transition:0.5s;
	-webkit-appearance:none;
	-moz-appearance:none;
	appearance:none;
	cursor:pointer;
	}

	[type="checkbox"]:checked {
	background-position:right,left;
	}

	[type="text"],[type="number"],[type="password"] {
	--s:15px; /* adjust this to control the size*/
	/*height:var(--s);
	aspect-ratio:2/1;
	padding:calc(var(--s)/5);*/
	border-radius:8px; 
	background:
		white;
	-webkit-appearance:none;
	-moz-appearance:none;
	appearance:none;
	cursor:pointer;
	}

	select,[type="button"] {
		border-radius:8px;
	}

	body {
	background:gray;
	}

	#Home {background-color: gray;}
	#Status {background-color: gray;}
	#Network {background-color: gray;}
	#Config {background-color: gray;}
	#Control {background-color: gray;}
	#Update {background-color: gray;}
	#About {background-color: gray;}

	.spinner {
		position: absolute;
		left: 50%;
		top: 50%;
		height:100px;
		width:100px;
		margin:0px auto;
		-webkit-animation: rotation .6s infinite linear;
		-moz-animation: rotation .6s infinite linear;
		-o-animation: rotation .6s infinite linear;
		animation: rotation .6s infinite linear;
		border-left:10px solid rgba(0,174,239,.15);
		border-right:10px solid rgba(0,174,239,.15);
		border-bottom:10px solid rgba(0,174,239,.15);
		border-top:10px solid rgba(0,174,239,.8);
		border-radius:200%;
	}

	@-webkit-keyframes rotation {
		from {-webkit-transform: rotate(0deg);}
		to {-webkit-transform: rotate(359deg);}
	}
	@-moz-keyframes rotation {
		from {-moz-transform: rotate(0deg);}
		to {-moz-transform: rotate(359deg);}
	}
	@-o-keyframes rotation {
		from {-o-transform: rotate(0deg);}
		to {-o-transform: rotate(359deg);}
	}
	@keyframes rotation {
		from {transform: rotate(0deg);}
		to {transform: rotate(359deg);}
	}


</style>

</head>
<body>
	<div class="topNav" id="mytopNav">
	  <a href="#home" class="tabLink" id="defaultOpen" name="Home" onclick="openPage('Home', this, 'red')">Home</a>
	  <a href="#status" class="tabLink" id="statusOpen" name="Status" style ="display:none"; onclick="openPage('Status', this, 'green');">Status<img id="statusImg" src="" style="margin-left:5px;height:16px;width:16px"></a>
	  <a href="#network" class="tabLink" id="networkOpen" name="Network" style ="display:none" onclick="openPage('Network', this, 'blue')">Network</a>
	  <a href="#config" class="tabLink" id="configOpen" name="Config" style ="display:none" onclick="openPage('Config', this, 'gray')">Config</a>
	  <a href="#control" class="tabLink" id="controlOpen" name="Control" style ="display:none" onclick="openPage('Control', this, 'gray')">Control</a>
	  <a href="#update" class="tabLink" id="updateOpen" name="Update" style ="display:none" onclick="openPage('Update', this, 'cyan')">Update</a>
	  <a href="#about" class="tabLink" id="aboutOpen" name="About" onclick="openPage('About', this, 'darkgray')">About</a>
	  <a href="javascript:void(0);" class="icon" onclick="resptopNav()">&#9776;</a>
	</div>

	<div id="spinner"></div>

	<div id="Home" class="tabContent">
	<div class="container1">
		<div class="rtabframe">
		<h3>VDMot Controller</h3>
		<table id="homeInfo" class="tabTable">
			<tr>
				<th>Station</th>
				<td id="sysStation"></td>
			</tr>
			<tr>
				<th>Time</th>
				<td id="locTime"></td>
			</tr>
			<tr>
				<th>Up Time</th>
				<td id="upTime"></td>
			</tr>
			<tr>
				<td>
				<input type="button" class="buttonclass" id="login-button" style ="display:none" value="Login" title="Login" />
				</td>
			</tr>
		</table>
		</div>
		<div class="rtabframe">
		<h3>WT32 Controller</h3>
		<table id="homeInfo" class="tabTable">
			<tr>
				<th width=100>SW Version</th>
				<td id="sysWt32-Version"></td>
			</tr>
			<tr>
				<th>Model</th>
				<td id="wt32-ChipModel"></td>
			</tr>
			<tr>
				<th>Cores</th>
				<td id="wt32-ChipCores"></td>
			</tr>
			<tr>
				<th>Version</th>
				<td id="wt32-ChipVersion"></td>
			</tr>
			<tr>
				<th>Flash size used</th>
				<td id="wt32-Sketch"></td>
				<td width=50 id="wt32-FlashUsed" ></td>
			</tr>
			<tr>
				<th>Stack size</th>
				<td id="wt32-ChipStack"></td>
			</tr>
			<tr>
				<th>Heap/Min</th>
				<td id="heap"></td>
				<td width=70 id="min-heap"></td>
			</tr>	
			<tr id="tr-rssi">
				<th>RSSI</th>
				<td id="rssi"></td>
			</tr>
		</table>
		</div>
		<div class="rtabframe">
		<h3>STM32 Controller</h3>
		<table id="homeInfo" class="tabTable">
			<tr>
				<th>Version</th>
				<td id="sysSTM32-Version"></td>
			</tr>
			<tr>
				<th>Chip Id</th>
				<td id="sysSTM32-ChipId"></td>
			</tr>
		</table>
		</div>
	</div>
	</div>
	
	<div id="Status" class="tabContent">
	<div class="container3">
		<div id="divValvesTable" class="rtabframe3">  
		<h3>Valves</h3>	
		<table id="valvesTable" class="tabTable" border="3" frame="box" style="text-align:center">
		</table>
		</div>
		<div class="rtabframe" style="overflow-y:auto" id="addStatusTabFrame">  
			<h3>Miscellaneous</h3>
			<table id="miscStatus" class="tabTable1">
				<tr>
					<th>Heat Control</th>
					<td id="miscStatusHC"></td>
				</tr>
				<tr>
					<th>Last Calibration</th>
					<td id="miscStatusLC"></td>
				</tr>
				<tr>
					<th>Show status detailed</th>
					<td>
					<input type="checkbox" id="status-detailed" name="status-detailed" title="Show detailed status"/>
					</td>
				</tr>
			</table>
		</div>
		<div class="rtabframe" style="overflow-y:auto" id="tempStatusTabFrame">  
		<h3>Temperature</h3>
		<table id="tempsTable" class="tabTable" border="3" frame="box" style="text-align:center">
		</table>
		</div>
	</div>
	</div>
	
	<div id="Network" class="tabContent">
		<div class="tabframe" style="width: 300px;"> 
		<h3>Network</h3>
		<table id="netInfo" class="tabTable1">
			<tr>
				<th>Eth/Wifi</th>
				<td id="net-EthWifi"></td>
			</tr>
			<tr>
				<th>DHCP</th>
				<td id="net-dhcp"></td>
			</tr>
			<tr>
				<th>IP</th>
				<td id="net-ip"></td>
			</tr>
			<tr>
				<th>MAC</th>
				<td id="net-MAC"></td>
			</tr>
			<tr>
				<th>Subnet Mask</th>
				<td id="net-mask"></td>
			</tr>
			<tr>
				<th>Gateway</th>
				<td id="net-gw"></td>
			</tr>
			<tr>
				<th>DNS</th>
				<td id="net-dns"></td>
			</tr>
			</table>
			<table id="net-broker" class="tabTable1" style="display:none">
			<tr>
				<th>MQTT</th>
				<td id="net-broker-status"></td>
			</tr>
			<tr>
				<th>SNTP</th>
				<td id="net-sntp-status"></td>
			</tr>
			
		</table>
		</div>
	</div>
	
	<div id="Config" class="tabContent">
	<div id="spinner-Config"></div>
	<div class="container">
		<div class="rtabframe">
		<h3>Network</h3>
		<table id="netConfig" class="tabTable1">
			<tr>
				<th>Station</th>
				<td>
				<input type="text" maxlength="20" class="form-input" id="sysCfg-StationName" name="sysCfg-StationName" />
				</td>
			</tr>
			<tr>
				<th>User name</th>
				<td>
				<input type="text" maxlength="64" class="form-input" id="netcfg-UserName" name="netcfg-UserName" />
				</td>
			</tr>
			<tr>
				<th>User password</th>
				<td>
				<input type="password" maxlength="64" class="form-input" id="netcfg-UserPwd" name="netcfg-UserPwd"/>
				</td>
			</tr>
			<tr>
				<th>Re-type user password</th>
				<td>
				<input type="password" maxlength="64" class="form-input" id="netcfg-UserPwd2" name="netcfg-UserPwd2"/>
				</td>
			</tr>
			<tr>
				<th>DHCP</th>
				<td>
				<select id="netcfg-dhcp" style="width: 60px;">
                    <option>OFF</option>
                    <option>ON</option>
				</select>
				</td>
            </tr>  
			<table id="netcfg-Tdhcp" style="display:none;" class="tabTable1">                 
				<tr>
					<th>IP</th>
					<td>
					<input type="text" class="form-input" id="netcfg-ip" name="netcfg-ip" placeholder="xxx.xxx.xxx.xxx"/>
					</td>
				</tr>
				<tr>
					<th>Subnet Mask</th>
					<td>
					<input type="text" class="form-input" id="netcfg-mask" name="netcfg-mask" placeholder="xxx.xxx.xxx.xxx"/>
					</td>
				</tr>
				<tr>
					<th>Gateway</th>
					<td>
					<input type="text" class="form-input" id="netcfg-gw" name="netcfg-gw" placeholder="xxx.xxx.xxx.xxx"/>
					</td>
				</tr>
				<tr>
					<th>DNS</th>
					<td>
					<input type="text" class="form-input" id="netcfg-dns" name="netcfg-dns" placeholder="xxx.xxx.xxx.xxx"/>
					</td>
				</tr>
			</table> 
			<table class="tabTable1"> 
				<tr> 
					<th>Eth/Wifi</th>
					<td>
					<select id="netcfg-EthWifi" style="width: 60px;">
						<option>Auto</option>
						<option>Eth</option>
						<option>Wifi</option>
					</select>
					</td>
				</tr>  
			</table>
		</table>
		
		<table id="netcfg-wifi" style="display:none;" class="tabTable1">
				<tr>
				<th>Wifi SSID</th>
				<td>
				<input type="text" maxlength="64" class="form-input" id="netcfg-WifiSSID" name="netcfg-WifiSSID" />
				</td>
			</tr>
			<tr>
				<th>Wifi password</th>
				<td>
				<input type="password" maxlength="64" class="form-input" id="netcfg-WifiPwd" name="netcfg-WifiPwd"/>
				</td>
			</tr>
			<tr>
				<th>Re-type wifi password</th>
				<td>
				<input type="password" maxlength="64" class="form-input" id="netcfg-WifiPwd2" name="netcfg-WifiPwd2"/>
				</td>
			</tr>
		</table>
		<tr><th></th></tr>
		
		<div class="tabiframe"> 
		<table id="netcfg-time" class="tabTable1">
			
			<tr><th>Time server</th></tr>
			<tr>
				<th>Name</th>
				<td>
				<input type="text" maxlength="64" class="form-input" id="netcfg-TimeServer" name="netcfg-TimeServer" />
				</td>
			</tr>
			<tr>
				<th>Time zone</th>
				<td>
					<select id="netcfg-tz" style="width: 200px;" onchange="getTZCode()"> </select>
				</td>
			</tr>
			<tr>
				<th>Time zone code</th>
				<td id="netcfg-tzCode" style="font-size:small"></td>
			</tr>
		</table>
		</div>
		
		<div class="tabiframe"> 
		<table id="netcfg-syslog" class="tabTable1">		
			<tr>
				<th>Syslog server</th>
				<td>
				<select id="netcfg-syslog-select">
                    <option>Off</option>
                    <option>Small</option>
					<option>Detail</option>
                    <option>Atomic</option>
				</select>
				</td>
            </tr> 
		</table>
		<table id="netcfg-syslog-table" style="display:none;" class="tabTable1">
				<tr>
				<th>Client IP</th>
				<td>
				<input type="text" class="form-input" id="netcfg-syslog-ip" name="netcfg-syslog-ip" placeholder="xxx.xxx.xxx.xxx"/>
				</td>
			</tr>
			<tr>
				<th>Port</th>
				<td>
				<input type="text" class="form-input" id="netcfg-syslog-port" name="netcfg-syslog-port" placeholder="xxxx"/>
				</td>
			</tr>
		</table>
		<table class="tabTable">
			<tr>
			<td>
			<input type="button" class="buttonclass" id="setSysLog" value="Set" title="Set syslog server values" />
			</td>
			</tr>
		</table>
		</div>
		</div>

		<div class="rtabframe" >
		<h3>Protocol</h3>

		<table id="protConfig" class="tabTable1">		
			<tr>
				<th>Data protocol</th>
				<td>
				<select id="protcfg-dataProt">
                    <option>none</option>
                    <option>MQTT</option>
				</select>
				</td>
            </tr> 
		</table>
		<table id="protcfg-Broker" style="display:none;" class="tabTable1">
			<tr>
				<th>Broker IP</th>
				<td>
				<input type="text" class="form-input" id="protcfg-Ip" name="protcfg-Ip" placeholder="xxx.xxx.xxx.xxx"/>
				</td>
			</tr>
			<tr>
				<th>Broker Port</th>
				<td>
				<input type="text" class="form-input" id="protcfg-Port" name="protcfg-Port" placeholder="xxxxx"/>
				</td>
			</tr>
			<tr>
				<th>User name</th>
				<td>
				<input type="text" class="form-input" id="protcfg-User" name="protcfg-User"/>
				</td>
			</tr>
			<tr>
				<th>Password</th>
				<td>
				<input type="password" maxlength="64" class="form-input" id="protcfg-Pwd" name="protcfg-Pwd"/>
				</td>
			</tr>
			<tr>
				<th>Re-type password</th>
				<td>
				<input type="password" maxlength="64" class="form-input" id="protcfg-Pwd2" name="protcfg-Pwd2"/>
				</td>
			</tr>
		</table>
		<div id="div-protcfg-Broker3" class="tabpframe"> 	
		<table id="protcfg-Broker3" style="display:none;" class="tabTable1">
			<tr>
				<th>Interval (ms)</th>
				<td>
				<input type="number" class="form-input" min="100" id="protcfg-Interval" name="protcfg-Interval" title="Polling interval in ms (default 1000). This polls the mqtt connection for events coming from broker"/>
				</td>
			</tr>
			<tr>
				<th>Publish Interval (s)</th>
				<td>
				<input type="number" class="form-input" min="2" id="protcfg-Publish" name="protcfg-Publish" title="If Publish on change is not checked, it defines the publish interval of all values in seconds (default 10), otherwise it defines the time out to publish the values even the value was not changed."/>
				</td>
			</tr>
			<tr>
				<th>Publish on change</th>
				<td>
				<input type="checkbox" id="protcfg-pubOnChange" name="protcfg-pubOnChange" title="Publish values if changed or time out (defined in Publish interval, individually for each valve and temperature sensor)"/>
				</td>
			</tr>
			<tr id="tr-minPubTime">
				<th>Min time for next publish (s)</th>
				<td>
				<input type="number" class="form-input" min="2" id="protcfg-pubMinDelay" name="protcfg-pubMinDelay" title="Minimum time (in seconds) the system wait for the next publishing values, individually for each valve and temperature sensor"/>
				</td>
			</tr>
			<tr>
				<th>Keep alive time (s)</th>
				<td>
				<input type="number" class="form-input" min="100" id="protcfg-keepAliveTime" name="protcfg-keepAliveTime" title="After this time the connection will be closed if there is no traffic"/>
				</td>
			</tr>
		</table>
		</div>
		<div class="tabpframe"> 
		<table id="protcfg-Broker1" style="display:none;" class="tabTable1">
			<tr>
				<fieldset id="protcfg-Broker2" class="checkboxgroup2" style="height:14em;display:none;">
					<legend>Publish</legend>
					<label><input type="checkbox" id="protcfg-pubRetained" name="theGroupP" title="Publish values retained">Retained </label>
					<label><input type="checkbox" id="protcfg-pubPlainText" name="theGroupP" title="Publish values as plaintext instead 0/1">Plaintext </label>
					<label><input type="checkbox" id="protcfg-pubSeparate" name="theGroupP" title="Handle topics strict separate for write and read. Topics sent from server has to be added a /set">Strict separate topics </label>
					<label><input type="checkbox" id="protcfg-pubAllTemps" name="theGroupP">All temps </label>
					<label><input type="checkbox" id="protcfg-pubPathAsRoot" name="theGroupP">Path as root </label>
					<label><input type="checkbox" id="protcfg-pubUpTime" name="theGroupP">Up time </label>
					<label><input type="checkbox" id="protcfg-pubDiag" name="theGroupP">Diag </label>
				</fieldset>
			</tr>

			<tr>
				<fieldset id="protcfg-Broker21" class="checkboxgroup2" style="height:7em;display:none;">
					<legend>Failed</legend>
					<label><input type="checkbox" id="protcfg-timeOutDSActive" name="theGroupP21" title="Time out for DS18 sensor (fixed 5 min)">DS18 </label>
					<label><input type="checkbox" id="protcfg-timeOutTSActive" name="theGroupP21" title="If there is no tValue received via mqtt after this time the corresponding valve goes to the defined position.
Caution : If this option is activated it is absolutely mandatory to ensure that the tValue is received within the time frame. 
Publish on change on server side is not recommended with this option">tValue after<input type="number" class="form-input3" maxlength="4" style="width:3em;" min="10" id="protcfg-timeOutValue" name="protcfg-timeOutValue" />min</label>
					<label><input type="number" class="form-input" min="0" max="100" maxlength="3" style="width:40px" id="protcfg-timeOutPosition" name="protcfg-timeOutPosition" title="Valve position after time out."/>Valve position </label>
				</fieldset>
			</tr>

		</table>
		</div>
		</div>

		<div class="rtabframe">
		<h3>Valves</h3>
		<table id="cfgValvesTable" class="tabTable" border="3" frame="box" style="text-align:center;">
		
		</table>
		<table class="tabTable">
			<tr>
			<td>
			<input type="button" class="buttonclass" id="valvesDetect" value="Scan" title="Detect valves" />
			</td>
			</tr>
		</table>
		</div>
		
		<div class="rtabframe" id ="motorTabFrame">
			<h3>Motor</h3>
		
			<table id="cfgValvesTable1" class="tabTable">
			<tr>
			<fieldset class="checkboxgroup2" style="height:17em;" id="cfgValvesTableFieldSet1">
				<legend>Next Calibration</legend>
				<label><input type="number" min="50" maxlength="4" style="width:60px" id="vCfg-movCalib" name="vCfg-movCalib" title="Number of movements to next calibration"> Movements </label>
				<div id="calibDate"> 
					<label><input type="number" max="24" min="0" maxlength="2" style="width:60px" id="vCfg-hCalib" name="vCfg-hCalib" title="Hour time of next calibration"> Hour time</label>
					<label><input type="checkbox" id="vCfg-d0" name="theGroup">Sunday </label>
					<label><input type="checkbox" id="vCfg-d1" name="theGroup">Monday </label>
					<label><input type="checkbox" id="vCfg-d2" name="theGroup">Tuesday </label>
					<label><input type="checkbox" id="vCfg-d3" name="theGroup">Wednesday </label>
					<label><input type="checkbox" id="vCfg-d4" name="theGroup">Thursday </label>
					<label><input type="checkbox" id="vCfg-d5" name="theGroup">Friday </label>
					<label><input type="checkbox" id="vCfg-d6" name="theGroup">Saturday </label>
				</div>
			</fieldset>
			<fieldset class="checkboxgroup2" style="height:8em;" id="cfgValvesTableFieldSet2">
				<legend>Characteristic</legend>	
				<label><input type="number" min=0.5 max=5.0 maxlength=2 step=.1 style="width:60px" id="vCfg-lowC" name="vCfg-lowC" title="Max. current factor from mean"> Open  </label>
				<label><input type="number" min=0.5 max=5.0 maxlength=2 step=.1 style="width:60px" id="vCfg-highC" name="vCfg-highC" title="Max. current factor from mean"> Close </label>
				<label><input type="number" min=0 max=100 maxlength=3 step=1 style="width:60px" id="vCfg-StartOnPower" name="vCfg-StartOnPower" title="Start valves % at power on"> Start % </label>
				<label><input type="number" min=0 max=60000 maxlength=5 step=1 style="width:60px" id="vCfg-noOfMinCount" name="vCfg-noOfMinCount" title="Number of minimum count detetced during calibration"> Min. count </label>
				<label><input type="number" min=0 max=2 maxlength=5 step=1 style="width:60px" id="vCfg-maxCalReps" name="vCfg-maxCalReps" title="Max. number of consecutive calibration repetitions if minimum count detected"> Max. calib. repetitions </label>
	
			</fieldset>
			</tr>
			<fieldset class="checkboxgroup2" style="height:4em;" id="cfgValvesTableFieldSet2">
				<legend>Assembly/Calibration</legend>	
				<label> 
					<select id="valvesAsmCalib-select">
					</select>	
					<input type="button" class="buttonclass" id="valvesAssembly" value="Assembly" title="Set valves to assembly position">
					<input type="button" class="buttonclass" id="valvesStartCalib" value="Calib" title="Start manual calibration of valves" />
				</label>	
			</fieldset>
			</table>
	
		</div>	
			<div class="rtabframe2">
			<h3>Temperature sensor</h3>
			<div style="height:390px;overflow-y:scroll">
			<table id="cfgTSensorTable" class="tabTable" border="3" frame="box" style="text-align:center">
			
			</table>
			</div>
			<div class="tabiframe">	
				<table id="cfgTSensorTable1" class="tabTable">
				<tr>
					<td>
					<input type="button" class="buttonclass" id="tempSensorScan" value="Scan" title="Scan temperature sensors" />
					</td>
					<td>
					<select id="sysCfg-CF">
						<option>Celsius</option>
						<option>Fahrenheit</option>
					</select>
					</td>
				</tr>
				</table>
			</div>
		</div>

		<dialog id="pushOverParameterDialog" class="dialogClass">
			<h3>PushOver</h3>
			<table id="cfgPushOverParam" class="tabTable">
			<tr>
				<button id="test-pushOver" class="buttonclass1">test</button>
			</tr>
			<tr>
				<button id="close-pushOverParameterDialog" class="buttonclass1">close</button>
			</tr>
			<tr>
				<th>API Token</th>
				<td>
				<input type="text" class="form-input2" maxlength="30" id="cfgPushOverAPIToken" name="cfgPushOverAPIToken"/>
				</td>
			</tr>
			<tr>
				<th>User Token</th>
				<td>
				<input type="text" class="form-input2" maxlength="30" id="cfgPushOverUserToken" name="cfgPushOverUserToken"/>
				</td>
			</tr>
			<tr>
				<th>Title</th>
				<td>
				<input type="text" class="form-input2" maxlength="30" id="cfgPushOverTitle" name="cfgPushOverTitle"/>
				</td>
			</tr>
			
			</table>
		</dialog>

		<dialog id="emailParameterDialog" class="dialogClass">
			<h3>Email</h3>
			<table id="cfgEmailParam" class="tabTable">
			<tr>
				<button id="test-email" class="buttonclass1">test</button>
			</tr>
			<tr>
				<button id="close-emailParameterDialog" class="buttonclass1">close</button>
			</tr>
			<tr>
				<th>User</th>
				<td>
				<input type="text" class="form-input2" maxlength="30" id="cfgEmailUser" name="cfgEmailUser"/>
				</td>
			</tr>
			<tr>
				<th>Password</th>
				<td>
				<input type="password" class="form-input2" maxlength="30" id="cfgEmailPwd" name="cfgEmailPwd"/>
				</td>
			</tr>
			<tr>
				<th>Host</th>
				<td>
				<input type="text" class="form-input2" maxlength="30" id="cfgEmailHost" name="cfgEmailHost"/>
				</td>
			</tr>
			<tr>
				<th>Port</th>
				<td>
				<input type="number" class="form-input2" id="cfgEmailPort" name="cfgEmailPort"/>
				</td>
			</tr>
			<tr>
				<th>Recipient</th>
				<td>
				<input type="text" class="form-input2" maxlength="30" id="cfgEmailRecipient" name="cfgEmailRecipient"/>
				</td>
			</tr>
			<tr>
				<th>Title</th>
				<td>
				<input type="text" class="form-input2" maxlength="30" id="cfgEmailTitle" name="cfgEmailTitle"/>
				</td>
			</tr>
			</table>
		</dialog>
		
		<div class="rtabframe" id ="messengerTabFrame" style="height:400px">
			<h3>Messenger</h3>
			<table id="cfgValvesTable1" class="tabTable">
				<tr>
				<fieldset class="checkboxgroup1" style="height:5em;" id="cfgMessengerFieldSet1">
					<legend>Active</legend>
					<label><input type="checkbox" id="MsgPOCfg-Active" name="theGroup">Pushover <input type="button" class="buttonclass1" id="msgCfg-PushOverParam" style="height:2em;" value="..." title="Push over parameter" /></label>
					<label><input type="checkbox" id="MsgEmailCfg-Active" name="theGroup">Email <input type="button" class="buttonclass1" id="msgCfg-emailParam" style="height:2em;" value="..." title="Email parameter" /></label>
				</fieldset>
				<fieldset class="checkboxgroup1" style="height:14em;" id="cfgValvesTableFieldSet2">
					<legend>Send reasons</legend>	
					<label><input type="checkbox" id="MsgCfg-ReasonValveFailed" name="theGroup" title="If a time out occured. Maybe the motor is dropped">Valve failed </label>
					<label><input type="checkbox" id="MsgCfg-ReasonValveBlocked" name="theGroup" title="If the valve is blocked (number of detected count less than motor config)">Valve blocked </label>
					<label><input type="checkbox" id="MsgCfg-ReasonValveDetect" name="theGroup">Active valve not detected </label>
					<label><input type="checkbox" id="MsgCfg-ReasonReset" name="theGroup">Reset detected </label>
					<label><input type="checkbox" id="MsgCfg-ReasonMQTT" name="theGroup">MQTT failed,after<input type="number" class="form-input3" maxlength="3" style="width:3em;" min="1" max="999" id="protcfg-timeOutMqtt" name="protcfg-timeOutMqtt" title="Timeout (min) to check mqtt connection to send messenge"/>min</label>
					<label><input type="checkbox" id="MsgCfg-ReasontValueFailed" name="theGroup" title="If tValue was not updated within mqtt timeout">tValue failed </label>
					<label><input type="checkbox" id="MsgCfg-ReasonDS18Failed" name="theGroup">DS18 failed </label>
				</fieldset>
				</tr>
			</table>
		</div>

		<div class="rtabframe" id ="fileTabFrame" style="height:290px">
		<h3>Files</h3>
		<table id="filesConfig" class="tabTable">
			<tr>
			<td>
			<label>Please select one file:
			<tr>
			<td>
			<select id="fileSelect" size="5">
			  
			</select>
			</td>
			</label>
			</tr>
			</tr>
			<tr>
				<td>
				<input type="button" class="buttonclass" id="fileDelete" value="Delete file" title="Delete selected file"/>
				
				<input type="button" class="buttonclass" id="formatFS" value="Format FS" title="Format FS"/>
				</td>

			</tr>
		</table>
		</div>
		
		<div class="rtabframe" style="height:290px">
		<h3>System</h3>
		<table id="sysConfig" class="tabTable">
			<tr>
				<td>
                <input type="button" class="buttonclass" id="sysReboot" value="Reboot system" title="Reboot system" />
                </td>
			</tr>
			<tr>
                <td>
                <input type="button" class="buttonclass" id="saveConfig" value="Save config" title="Save all settings."/>
                </td>
            </tr>
			<tr></tr>
			<tr>
                <td>
                <input type="button" class="buttonclass" id="factoryRestore" value="Restore factory default settings" title="Reset config including network settings."/>
                </td>
            </tr>
			<tr>
				<td>
                <input type="button" class="buttonclass" id="resetConfig" value="Reset config" title="Reset config excluding network settings." />
                </td>
			</tr>	
		</table>
		</div>
		</div>
	</div>
	
	<div id="Control" class="tabContent">
	<div class="container">
		<div class="rtabframe3">  
			<h3>Valves</h3>	
			<table id="cfgValvesControlTable" class="tabTable" border="3" frame="box" style="text-align:center">
			</table>
			<table class="tabTable">
			<tr>
				<td>
				<input type="button" class="buttonclass" id="saveVCtrlConfig" value="Save valve control settings" title="Save settings for valves control."/>
				</td>
				<td>
					<label>Heat Control</label>
					<select id="VCtrlConfigHeatControl" title="Heat valves control manual/on Heating/on Cooling/off=Park position.">
					<option>Manual</option>
					<option>On/Heating</option>
					<option>On/Cooling</option>
					<option>Off/Park position</option>
					</select>
				
				</td>
				<td>
					<label>Park Position</label>
					<input type="number" class="form-input" style="width:50px;" min="0" max="100" id="VCtrlConfigParkPosition" title="Park position if Heat Control is off."/>
				</td>
			</tr>
			</table>
		</div>
	</div>
	</div>
	
	<div id="Update" class="tabContent">
		<div class="rtabframe" style="width: 250px;">
		<h3>Update</h3>
		<table id="sysUpdate" class="tabTable">
			<tr>
				<td>
                <input type="button" class="buttonclass" id="update-WT32" value="Update WT32" title="Update WT32" />
                </td>
			</tr>
			<tr>
				<td>
                <input type="button" class="buttonclass" id="update-STM32" value="Update STM32" title="Update WT32" />
                </td>
			</tr>
		</table>
		</div>
	</div>
	
	<div id="About" class="tabContent">
		<div class="tabframe" style="width: 450px;">
		<h3>About this VDMot controller</h3>
		<table id="aboutInfo" class="tabTable">
		<p> 
		THIS SOFTWARE IS PROVIDED "AS IS" AND ANY EXPRESSED OR
		IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
		OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
		IN NO EVENT SHALL THE DEVELOPER OR ANY CONTRIBUTORS BE LIABLE FOR ANY DIRECT,
		INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
		(INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
		SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
		HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,
		STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING
		IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF
		THE POSSIBILITY OF SUCH DAMAGE. 
		</p>
		<p> 	
		This program is free software: you can redistribute it and/or modify
		it under the terms of the GNU General Public License as published by
		the Free Software Foundation, either version 3 of the License.
		</p>
		<p> 
		See the GNU General Public License for more details.

		You should have received a copy of the GNU General Public License
		along with this program.  If not, see http://www.gnu.org/licenses/.
		</p>
		<p>
		Copyright (C) 2021-2024 Lenti84  https://github.com/Lenti84/VdMot_Controller
		</p>	
		<p>
		Contributor : SurfGargano
		</p>
		</table>
		</div>
	</div>

	<div id="pwdModal" class="modal">
	  <div class="modal-content">
		<span class="close">&times;</span>
		<p>Please type user and password</p>
		<table>
			<th>User name</th>
				<td colspan='10'>
				<input type="text" maxlength="64" class="form-input1" id="dialogUserInput" name="dialogUserInput" />
				</td>
			</tr>
			<tr>
				<th>User password</th>
				<td colspan='10'>
				<input type="password" maxlength="64" class="form-input1" id="dialogPwdInput" name="dialogPwdInput"/>
				</td>
			</tr>
			<tr>
			<td></td><td>
	          <input type="button" class="buttonclass" id="dialogOk" value="ok" title="Please enter user name" />
			</td><td>
			 <input type="button" class="buttonclass" id="dialogCancel" value="cancel" title="Please enter password" />
			</td>
			</tr>
		</table>
	  </div>

	</div>


	<script>		
				
		const jsonTZ = 
		{
    "Africa/Abidjan":"GMT0",
    "Africa/Accra":"GMT0",
    "Africa/Addis_Ababa":"EAT-3",
    "Africa/Algiers":"CET-1",
    "Africa/Asmara":"EAT-3",
    "Africa/Bamako":"GMT0",
    "Africa/Bangui":"WAT-1",
    "Africa/Banjul":"GMT0",
    "Africa/Bissau":"GMT0",
    "Africa/Blantyre":"CAT-2",
    "Africa/Brazzaville":"WAT-1",
    "Africa/Bujumbura":"CAT-2",
    "Africa/Cairo":"EET-2",
    "Africa/Casablanca":"<+01>-1",
    "Africa/Ceuta":"CET-1CEST,M3.5.0,M10.5.0/3",
    "Africa/Conakry":"GMT0",
    "Africa/Dakar":"GMT0",
    "Africa/Dar_es_Salaam":"EAT-3",
    "Africa/Djibouti":"EAT-3",
    "Africa/Douala":"WAT-1",
    "Africa/El_Aaiun":"<+01>-1",
    "Africa/Freetown":"GMT0",
    "Africa/Gaborone":"CAT-2",
    "Africa/Harare":"CAT-2",
    "Africa/Johannesburg":"SAST-2",
    "Africa/Juba":"CAT-2",
    "Africa/Kampala":"EAT-3",
    "Africa/Khartoum":"CAT-2",
    "Africa/Kigali":"CAT-2",
    "Africa/Kinshasa":"WAT-1",
    "Africa/Lagos":"WAT-1",
    "Africa/Libreville":"WAT-1",
    "Africa/Lome":"GMT0",
    "Africa/Luanda":"WAT-1",
    "Africa/Lubumbashi":"CAT-2",
    "Africa/Lusaka":"CAT-2",
    "Africa/Malabo":"WAT-1",
    "Africa/Maputo":"CAT-2",
    "Africa/Maseru":"SAST-2",
    "Africa/Mbabane":"SAST-2",
    "Africa/Mogadishu":"EAT-3",
    "Africa/Monrovia":"GMT0",
    "Africa/Nairobi":"EAT-3",
    "Africa/Ndjamena":"WAT-1",
    "Africa/Niamey":"WAT-1",
    "Africa/Nouakchott":"GMT0",
    "Africa/Ouagadougou":"GMT0",
    "Africa/Porto-Novo":"WAT-1",
    "Africa/Sao_Tome":"GMT0",
    "Africa/Tripoli":"EET-2",
    "Africa/Tunis":"CET-1",
    "Africa/Windhoek":"CAT-2",
    "America/Adak":"HST10HDT,M3.2.0,M11.1.0",
    "America/Anchorage":"AKST9AKDT,M3.2.0,M11.1.0",
    "America/Anguilla":"AST4",
    "America/Antigua":"AST4",
    "America/Araguaina":"<-03>3",
    "America/Argentina/Buenos_Aires":"<-03>3",
    "America/Argentina/Catamarca":"<-03>3",
    "America/Argentina/Cordoba":"<-03>3",
    "America/Argentina/Jujuy":"<-03>3",
    "America/Argentina/La_Rioja":"<-03>3",
    "America/Argentina/Mendoza":"<-03>3",
    "America/Argentina/Rio_Gallegos":"<-03>3",
    "America/Argentina/Salta":"<-03>3",
    "America/Argentina/San_Juan":"<-03>3",
    "America/Argentina/San_Luis":"<-03>3",
    "America/Argentina/Tucuman":"<-03>3",
    "America/Argentina/Ushuaia":"<-03>3",
    "America/Aruba":"AST4",
    "America/Asuncion":"<-04>4<-03>,M10.1.0/0,M3.4.0/0",
    "America/Atikokan":"EST5",
    "America/Bahia":"<-03>3",
    "America/Bahia_Banderas":"CST6CDT,M4.1.0,M10.5.0",
    "America/Barbados":"AST4",
    "America/Belem":"<-03>3",
    "America/Belize":"CST6",
    "America/Blanc-Sablon":"AST4",
    "America/Boa_Vista":"<-04>4",
    "America/Bogota":"<-05>5",
    "America/Boise":"MST7MDT,M3.2.0,M11.1.0",
    "America/Cambridge_Bay":"MST7MDT,M3.2.0,M11.1.0",
    "America/Campo_Grande":"<-04>4",
    "America/Cancun":"EST5",
    "America/Caracas":"<-04>4",
    "America/Cayenne":"<-03>3",
    "America/Cayman":"EST5",
    "America/Chicago":"CST6CDT,M3.2.0,M11.1.0",
    "America/Chihuahua":"MST7MDT,M4.1.0,M10.5.0",
    "America/Costa_Rica":"CST6",
    "America/Creston":"MST7",
    "America/Cuiaba":"<-04>4",
    "America/Curacao":"AST4",
    "America/Danmarkshavn":"GMT0",
    "America/Dawson":"MST7",
    "America/Dawson_Creek":"MST7",
    "America/Denver":"MST7MDT,M3.2.0,M11.1.0",
    "America/Detroit":"EST5EDT,M3.2.0,M11.1.0",
    "America/Dominica":"AST4",
    "America/Edmonton":"MST7MDT,M3.2.0,M11.1.0",
    "America/Eirunepe":"<-05>5",
    "America/El_Salvador":"CST6",
    "America/Fort_Nelson":"MST7",
    "America/Fortaleza":"<-03>3",
    "America/Glace_Bay":"AST4ADT,M3.2.0,M11.1.0",
    "America/Godthab":"<-03>3<-02>,M3.5.0/-2,M10.5.0/-1",
    "America/Goose_Bay":"AST4ADT,M3.2.0,M11.1.0",
    "America/Grand_Turk":"EST5EDT,M3.2.0,M11.1.0",
    "America/Grenada":"AST4",
    "America/Guadeloupe":"AST4",
    "America/Guatemala":"CST6",
    "America/Guayaquil":"<-05>5",
    "America/Guyana":"<-04>4",
    "America/Halifax":"AST4ADT,M3.2.0,M11.1.0",
    "America/Havana":"CST5CDT,M3.2.0/0,M11.1.0/1",
    "America/Hermosillo":"MST7",
    "America/Indiana/Indianapolis":"EST5EDT,M3.2.0,M11.1.0",
    "America/Indiana/Knox":"CST6CDT,M3.2.0,M11.1.0",
    "America/Indiana/Marengo":"EST5EDT,M3.2.0,M11.1.0",
    "America/Indiana/Petersburg":"EST5EDT,M3.2.0,M11.1.0",
    "America/Indiana/Tell_City":"CST6CDT,M3.2.0,M11.1.0",
    "America/Indiana/Vevay":"EST5EDT,M3.2.0,M11.1.0",
    "America/Indiana/Vincennes":"EST5EDT,M3.2.0,M11.1.0",
    "America/Indiana/Winamac":"EST5EDT,M3.2.0,M11.1.0",
    "America/Inuvik":"MST7MDT,M3.2.0,M11.1.0",
    "America/Iqaluit":"EST5EDT,M3.2.0,M11.1.0",
    "America/Jamaica":"EST5",
    "America/Juneau":"AKST9AKDT,M3.2.0,M11.1.0",
    "America/Kentucky/Louisville":"EST5EDT,M3.2.0,M11.1.0",
    "America/Kentucky/Monticello":"EST5EDT,M3.2.0,M11.1.0",
    "America/Kralendijk":"AST4",
    "America/La_Paz":"<-04>4",
    "America/Lima":"<-05>5",
    "America/Los_Angeles":"PST8PDT,M3.2.0,M11.1.0",
    "America/Lower_Princes":"AST4",
    "America/Maceio":"<-03>3",
    "America/Managua":"CST6",
    "America/Manaus":"<-04>4",
    "America/Marigot":"AST4",
    "America/Martinique":"AST4",
    "America/Matamoros":"CST6CDT,M3.2.0,M11.1.0",
    "America/Mazatlan":"MST7MDT,M4.1.0,M10.5.0",
    "America/Menominee":"CST6CDT,M3.2.0,M11.1.0",
    "America/Merida":"CST6CDT,M4.1.0,M10.5.0",
    "America/Metlakatla":"AKST9AKDT,M3.2.0,M11.1.0",
    "America/Mexico_City":"CST6CDT,M4.1.0,M10.5.0",
    "America/Miquelon":"<-03>3<-02>,M3.2.0,M11.1.0",
    "America/Moncton":"AST4ADT,M3.2.0,M11.1.0",
    "America/Monterrey":"CST6CDT,M4.1.0,M10.5.0",
    "America/Montevideo":"<-03>3",
    "America/Montreal":"EST5EDT,M3.2.0,M11.1.0",
    "America/Montserrat":"AST4",
    "America/Nassau":"EST5EDT,M3.2.0,M11.1.0",
    "America/New_York":"EST5EDT,M3.2.0,M11.1.0",
    "America/Nipigon":"EST5EDT,M3.2.0,M11.1.0",
    "America/Nome":"AKST9AKDT,M3.2.0,M11.1.0",
    "America/Noronha":"<-02>2",
    "America/North_Dakota/Beulah":"CST6CDT,M3.2.0,M11.1.0",
    "America/North_Dakota/Center":"CST6CDT,M3.2.0,M11.1.0",
    "America/North_Dakota/New_Salem":"CST6CDT,M3.2.0,M11.1.0",
    "America/Nuuk":"<-03>3<-02>,M3.5.0/-2,M10.5.0/-1",
    "America/Ojinaga":"MST7MDT,M3.2.0,M11.1.0",
    "America/Panama":"EST5",
    "America/Pangnirtung":"EST5EDT,M3.2.0,M11.1.0",
    "America/Paramaribo":"<-03>3",
    "America/Phoenix":"MST7",
    "America/Port-au-Prince":"EST5EDT,M3.2.0,M11.1.0",
    "America/Port_of_Spain":"AST4",
    "America/Porto_Velho":"<-04>4",
    "America/Puerto_Rico":"AST4",
    "America/Punta_Arenas":"<-03>3",
    "America/Rainy_River":"CST6CDT,M3.2.0,M11.1.0",
    "America/Rankin_Inlet":"CST6CDT,M3.2.0,M11.1.0",
    "America/Recife":"<-03>3",
    "America/Regina":"CST6",
    "America/Resolute":"CST6CDT,M3.2.0,M11.1.0",
    "America/Rio_Branco":"<-05>5",
    "America/Santarem":"<-03>3",
    "America/Santiago":"<-04>4<-03>,M9.1.6/24,M4.1.6/24",
    "America/Santo_Domingo":"AST4",
    "America/Sao_Paulo":"<-03>3",
    "America/Scoresbysund":"<-01>1<+00>,M3.5.0/0,M10.5.0/1",
    "America/Sitka":"AKST9AKDT,M3.2.0,M11.1.0",
    "America/St_Barthelemy":"AST4",
    "America/St_Johns":"NST3:30NDT,M3.2.0,M11.1.0",
    "America/St_Kitts":"AST4",
    "America/St_Lucia":"AST4",
    "America/St_Thomas":"AST4",
    "America/St_Vincent":"AST4",
    "America/Swift_Current":"CST6",
    "America/Tegucigalpa":"CST6",
    "America/Thule":"AST4ADT,M3.2.0,M11.1.0",
    "America/Thunder_Bay":"EST5EDT,M3.2.0,M11.1.0",
    "America/Tijuana":"PST8PDT,M3.2.0,M11.1.0",
    "America/Toronto":"EST5EDT,M3.2.0,M11.1.0",
    "America/Tortola":"AST4",
    "America/Vancouver":"PST8PDT,M3.2.0,M11.1.0",
    "America/Whitehorse":"MST7",
    "America/Winnipeg":"CST6CDT,M3.2.0,M11.1.0",
    "America/Yakutat":"AKST9AKDT,M3.2.0,M11.1.0",
    "America/Yellowknife":"MST7MDT,M3.2.0,M11.1.0",
    "Antarctica/Casey":"<+11>-11",
    "Antarctica/Davis":"<+07>-7",
    "Antarctica/DumontDUrville":"<+10>-10",
    "Antarctica/Macquarie":"AEST-10AEDT,M10.1.0,M4.1.0/3",
    "Antarctica/Mawson":"<+05>-5",
    "Antarctica/McMurdo":"NZST-12NZDT,M9.5.0,M4.1.0/3",
    "Antarctica/Palmer":"<-03>3",
    "Antarctica/Rothera":"<-03>3",
    "Antarctica/Syowa":"<+03>-3",
    "Antarctica/Troll":"<+00>0<+02>-2,M3.5.0/1,M10.5.0/3",
    "Antarctica/Vostok":"<+06>-6",
    "Arctic/Longyearbyen":"CET-1CEST,M3.5.0,M10.5.0/3",
    "Asia/Aden":"<+03>-3",
    "Asia/Almaty":"<+06>-6",
    "Asia/Amman":"EET-2EEST,M2.5.4/24,M10.5.5/1",
    "Asia/Anadyr":"<+12>-12",
    "Asia/Aqtau":"<+05>-5",
    "Asia/Aqtobe":"<+05>-5",
    "Asia/Ashgabat":"<+05>-5",
    "Asia/Atyrau":"<+05>-5",
    "Asia/Baghdad":"<+03>-3",
    "Asia/Bahrain":"<+03>-3",
    "Asia/Baku":"<+04>-4",
    "Asia/Bangkok":"<+07>-7",
    "Asia/Barnaul":"<+07>-7",
    "Asia/Beirut":"EET-2EEST,M3.5.0/0,M10.5.0/0",
    "Asia/Bishkek":"<+06>-6",
    "Asia/Brunei":"<+08>-8",
    "Asia/Chita":"<+09>-9",
    "Asia/Choibalsan":"<+08>-8",
    "Asia/Colombo":"<+0530>-5:30",
    "Asia/Damascus":"EET-2EEST,M3.5.5/0,M10.5.5/0",
    "Asia/Dhaka":"<+06>-6",
    "Asia/Dili":"<+09>-9",
    "Asia/Dubai":"<+04>-4",
    "Asia/Dushanbe":"<+05>-5",
    "Asia/Famagusta":"EET-2EEST,M3.5.0/3,M10.5.0/4",
    "Asia/Gaza":"EET-2EEST,M3.4.4/48,M10.5.5/1",
    "Asia/Hebron":"EET-2EEST,M3.4.4/48,M10.5.5/1",
    "Asia/Ho_Chi_Minh":"<+07>-7",
    "Asia/Hong_Kong":"HKT-8",
    "Asia/Hovd":"<+07>-7",
    "Asia/Irkutsk":"<+08>-8",
    "Asia/Jakarta":"WIB-7",
    "Asia/Jayapura":"WIT-9",
    "Asia/Jerusalem":"IST-2IDT,M3.4.4/26,M10.5.0",
    "Asia/Kabul":"<+0430>-4:30",
    "Asia/Kamchatka":"<+12>-12",
    "Asia/Karachi":"PKT-5",
    "Asia/Kathmandu":"<+0545>-5:45",
    "Asia/Khandyga":"<+09>-9",
    "Asia/Kolkata":"IST-5:30",
    "Asia/Krasnoyarsk":"<+07>-7",
    "Asia/Kuala_Lumpur":"<+08>-8",
    "Asia/Kuching":"<+08>-8",
    "Asia/Kuwait":"<+03>-3",
    "Asia/Macau":"CST-8",
    "Asia/Magadan":"<+11>-11",
    "Asia/Makassar":"WITA-8",
    "Asia/Manila":"PST-8",
    "Asia/Muscat":"<+04>-4",
    "Asia/Nicosia":"EET-2EEST,M3.5.0/3,M10.5.0/4",
    "Asia/Novokuznetsk":"<+07>-7",
    "Asia/Novosibirsk":"<+07>-7",
    "Asia/Omsk":"<+06>-6",
    "Asia/Oral":"<+05>-5",
    "Asia/Phnom_Penh":"<+07>-7",
    "Asia/Pontianak":"WIB-7",
    "Asia/Pyongyang":"KST-9",
    "Asia/Qatar":"<+03>-3",
    "Asia/Qyzylorda":"<+05>-5",
    "Asia/Riyadh":"<+03>-3",
    "Asia/Sakhalin":"<+11>-11",
    "Asia/Samarkand":"<+05>-5",
    "Asia/Seoul":"KST-9",
    "Asia/Shanghai":"CST-8",
    "Asia/Singapore":"<+08>-8",
    "Asia/Srednekolymsk":"<+11>-11",
    "Asia/Taipei":"CST-8",
    "Asia/Tashkent":"<+05>-5",
    "Asia/Tbilisi":"<+04>-4",
    "Asia/Tehran":"<+0330>-3:30<+0430>,J79/24,J263/24",
    "Asia/Thimphu":"<+06>-6",
    "Asia/Tokyo":"JST-9",
    "Asia/Tomsk":"<+07>-7",
    "Asia/Ulaanbaatar":"<+08>-8",
    "Asia/Urumqi":"<+06>-6",
    "Asia/Ust-Nera":"<+10>-10",
    "Asia/Vientiane":"<+07>-7",
    "Asia/Vladivostok":"<+10>-10",
    "Asia/Yakutsk":"<+09>-9",
    "Asia/Yangon":"<+0630>-6:30",
    "Asia/Yekaterinburg":"<+05>-5",
    "Asia/Yerevan":"<+04>-4",
    "Atlantic/Azores":"<-01>1<+00>,M3.5.0/0,M10.5.0/1",
    "Atlantic/Bermuda":"AST4ADT,M3.2.0,M11.1.0",
    "Atlantic/Canary":"WET0WEST,M3.5.0/1,M10.5.0",
    "Atlantic/Cape_Verde":"<-01>1",
    "Atlantic/Faroe":"WET0WEST,M3.5.0/1,M10.5.0",
    "Atlantic/Madeira":"WET0WEST,M3.5.0/1,M10.5.0",
    "Atlantic/Reykjavik":"GMT0",
    "Atlantic/South_Georgia":"<-02>2",
    "Atlantic/St_Helena":"GMT0",
    "Atlantic/Stanley":"<-03>3",
    "Australia/Adelaide":"ACST-9:30ACDT,M10.1.0,M4.1.0/3",
    "Australia/Brisbane":"AEST-10",
    "Australia/Broken_Hill":"ACST-9:30ACDT,M10.1.0,M4.1.0/3",
    "Australia/Currie":"AEST-10AEDT,M10.1.0,M4.1.0/3",
    "Australia/Darwin":"ACST-9:30",
    "Australia/Eucla":"<+0845>-8:45",
    "Australia/Hobart":"AEST-10AEDT,M10.1.0,M4.1.0/3",
    "Australia/Lindeman":"AEST-10",
    "Australia/Lord_Howe":"<+1030>-10:30<+11>-11,M10.1.0,M4.1.0",
    "Australia/Melbourne":"AEST-10AEDT,M10.1.0,M4.1.0/3",
    "Australia/Perth":"AWST-8",
    "Australia/Sydney":"AEST-10AEDT,M10.1.0,M4.1.0/3",
    "Etc/GMT":"GMT0",
    "Etc/GMT+0":"GMT0",
    "Etc/GMT+1":"<-01>1",
    "Etc/GMT+10":"<-10>10",
    "Etc/GMT+11":"<-11>11",
    "Etc/GMT+12":"<-12>12",
    "Etc/GMT+2":"<-02>2",
    "Etc/GMT+3":"<-03>3",
    "Etc/GMT+4":"<-04>4",
    "Etc/GMT+5":"<-05>5",
    "Etc/GMT+6":"<-06>6",
    "Etc/GMT+7":"<-07>7",
    "Etc/GMT+8":"<-08>8",
    "Etc/GMT+9":"<-09>9",
    "Etc/GMT-0":"GMT0",
    "Etc/GMT-1":"<+01>-1",
    "Etc/GMT-10":"<+10>-10",
    "Etc/GMT-11":"<+11>-11",
    "Etc/GMT-12":"<+12>-12",
    "Etc/GMT-13":"<+13>-13",
    "Etc/GMT-14":"<+14>-14",
    "Etc/GMT-2":"<+02>-2",
    "Etc/GMT-3":"<+03>-3",
    "Etc/GMT-4":"<+04>-4",
    "Etc/GMT-5":"<+05>-5",
    "Etc/GMT-6":"<+06>-6",
    "Etc/GMT-7":"<+07>-7",
    "Etc/GMT-8":"<+08>-8",
    "Etc/GMT-9":"<+09>-9",
    "Etc/GMT0":"GMT0",
    "Etc/Greenwich":"GMT0",
    "Etc/UCT":"UTC0",
    "Etc/UTC":"UTC0",
    "Etc/Universal":"UTC0",
    "Etc/Zulu":"UTC0",
    "Europe/Amsterdam":"CET-1CEST,M3.5.0,M10.5.0/3",
    "Europe/Andorra":"CET-1CEST,M3.5.0,M10.5.0/3",
    "Europe/Astrakhan":"<+04>-4",
    "Europe/Athens":"EET-2EEST,M3.5.0/3,M10.5.0/4",
    "Europe/Belgrade":"CET-1CEST,M3.5.0,M10.5.0/3",
    "Europe/Berlin":"CET-1CEST,M3.5.0,M10.5.0/3",
    "Europe/Bratislava":"CET-1CEST,M3.5.0,M10.5.0/3",
    "Europe/Brussels":"CET-1CEST,M3.5.0,M10.5.0/3",
    "Europe/Bucharest":"EET-2EEST,M3.5.0/3,M10.5.0/4",
    "Europe/Budapest":"CET-1CEST,M3.5.0,M10.5.0/3",
    "Europe/Busingen":"CET-1CEST,M3.5.0,M10.5.0/3",
    "Europe/Chisinau":"EET-2EEST,M3.5.0,M10.5.0/3",
    "Europe/Copenhagen":"CET-1CEST,M3.5.0,M10.5.0/3",
    "Europe/Dublin":"IST-1GMT0,M10.5.0,M3.5.0/1",
    "Europe/Gibraltar":"CET-1CEST,M3.5.0,M10.5.0/3",
    "Europe/Guernsey":"GMT0BST,M3.5.0/1,M10.5.0",
    "Europe/Helsinki":"EET-2EEST,M3.5.0/3,M10.5.0/4",
    "Europe/Isle_of_Man":"GMT0BST,M3.5.0/1,M10.5.0",
    "Europe/Istanbul":"<+03>-3",
    "Europe/Jersey":"GMT0BST,M3.5.0/1,M10.5.0",
    "Europe/Kaliningrad":"EET-2",
    "Europe/Kiev":"EET-2EEST,M3.5.0/3,M10.5.0/4",
    "Europe/Kirov":"<+03>-3",
    "Europe/Lisbon":"WET0WEST,M3.5.0/1,M10.5.0",
    "Europe/Ljubljana":"CET-1CEST,M3.5.0,M10.5.0/3",
    "Europe/London":"GMT0BST,M3.5.0/1,M10.5.0",
    "Europe/Luxembourg":"CET-1CEST,M3.5.0,M10.5.0/3",
    "Europe/Madrid":"CET-1CEST,M3.5.0,M10.5.0/3",
    "Europe/Malta":"CET-1CEST,M3.5.0,M10.5.0/3",
    "Europe/Mariehamn":"EET-2EEST,M3.5.0/3,M10.5.0/4",
    "Europe/Minsk":"<+03>-3",
    "Europe/Monaco":"CET-1CEST,M3.5.0,M10.5.0/3",
    "Europe/Moscow":"MSK-3",
    "Europe/Oslo":"CET-1CEST,M3.5.0,M10.5.0/3",
    "Europe/Paris":"CET-1CEST,M3.5.0,M10.5.0/3",
    "Europe/Podgorica":"CET-1CEST,M3.5.0,M10.5.0/3",
    "Europe/Prague":"CET-1CEST,M3.5.0,M10.5.0/3",
    "Europe/Riga":"EET-2EEST,M3.5.0/3,M10.5.0/4",
    "Europe/Rome":"CET-1CEST,M3.5.0,M10.5.0/3",
    "Europe/Samara":"<+04>-4",
    "Europe/San_Marino":"CET-1CEST,M3.5.0,M10.5.0/3",
    "Europe/Sarajevo":"CET-1CEST,M3.5.0,M10.5.0/3",
    "Europe/Saratov":"<+04>-4",
    "Europe/Simferopol":"MSK-3",
    "Europe/Skopje":"CET-1CEST,M3.5.0,M10.5.0/3",
    "Europe/Sofia":"EET-2EEST,M3.5.0/3,M10.5.0/4",
    "Europe/Stockholm":"CET-1CEST,M3.5.0,M10.5.0/3",
    "Europe/Tallinn":"EET-2EEST,M3.5.0/3,M10.5.0/4",
    "Europe/Tirane":"CET-1CEST,M3.5.0,M10.5.0/3",
    "Europe/Ulyanovsk":"<+04>-4",
    "Europe/Uzhgorod":"EET-2EEST,M3.5.0/3,M10.5.0/4",
    "Europe/Vaduz":"CET-1CEST,M3.5.0,M10.5.0/3",
    "Europe/Vatican":"CET-1CEST,M3.5.0,M10.5.0/3",
    "Europe/Vienna":"CET-1CEST,M3.5.0,M10.5.0/3",
    "Europe/Vilnius":"EET-2EEST,M3.5.0/3,M10.5.0/4",
    "Europe/Volgograd":"<+03>-3",
    "Europe/Warsaw":"CET-1CEST,M3.5.0,M10.5.0/3",
    "Europe/Zagreb":"CET-1CEST,M3.5.0,M10.5.0/3",
    "Europe/Zaporozhye":"EET-2EEST,M3.5.0/3,M10.5.0/4",
    "Europe/Zurich":"CET-1CEST,M3.5.0,M10.5.0/3",
    "Indian/Antananarivo":"EAT-3",
    "Indian/Chagos":"<+06>-6",
    "Indian/Christmas":"<+07>-7",
    "Indian/Cocos":"<+0630>-6:30",
    "Indian/Comoro":"EAT-3",
    "Indian/Kerguelen":"<+05>-5",
    "Indian/Mahe":"<+04>-4",
    "Indian/Maldives":"<+05>-5",
    "Indian/Mauritius":"<+04>-4",
    "Indian/Mayotte":"EAT-3",
    "Indian/Reunion":"<+04>-4",
    "Pacific/Apia":"<+13>-13",
    "Pacific/Auckland":"NZST-12NZDT,M9.5.0,M4.1.0/3",
    "Pacific/Bougainville":"<+11>-11",
    "Pacific/Chatham":"<+1245>-12:45<+1345>,M9.5.0/2:45,M4.1.0/3:45",
    "Pacific/Chuuk":"<+10>-10",
    "Pacific/Easter":"<-06>6<-05>,M9.1.6/22,M4.1.6/22",
    "Pacific/Efate":"<+11>-11",
    "Pacific/Enderbury":"<+13>-13",
    "Pacific/Fakaofo":"<+13>-13",
    "Pacific/Fiji":"<+12>-12<+13>,M11.2.0,M1.2.3/99",
    "Pacific/Funafuti":"<+12>-12",
    "Pacific/Galapagos":"<-06>6",
    "Pacific/Gambier":"<-09>9",
    "Pacific/Guadalcanal":"<+11>-11",
    "Pacific/Guam":"ChST-10",
    "Pacific/Honolulu":"HST10",
    "Pacific/Kiritimati":"<+14>-14",
    "Pacific/Kosrae":"<+11>-11",
    "Pacific/Kwajalein":"<+12>-12",
    "Pacific/Majuro":"<+12>-12",
    "Pacific/Marquesas":"<-0930>9:30",
    "Pacific/Midway":"SST11",
    "Pacific/Nauru":"<+12>-12",
    "Pacific/Niue":"<-11>11",
    "Pacific/Norfolk":"<+11>-11<+12>,M10.1.0,M4.1.0/3",
    "Pacific/Noumea":"<+11>-11",
    "Pacific/Pago_Pago":"SST11",
    "Pacific/Palau":"<+09>-9",
    "Pacific/Pitcairn":"<-08>8",
    "Pacific/Pohnpei":"<+11>-11",
    "Pacific/Port_Moresby":"<+10>-10",
    "Pacific/Rarotonga":"<-10>10",
    "Pacific/Saipan":"ChST-10",
    "Pacific/Tahiti":"<-10>10",
    "Pacific/Tarawa":"<+12>-12",
    "Pacific/Tongatapu":"<+13>-13",
    "Pacific/Wake":"<+12>-12",
    "Pacific/Wallis":"<+12>-12"
    };
	

		var id = function(elid) {
					var ret = document.getElementById(elid);
                    if(!ret){
                        console.log('No element found with id ' + elid);
                    }
                    return ret;
                };		
				
		var WifiPwdHasChanged=false;
		var UserPwdHasChanged=false;
		var brokerPwdHasChanged=false;
		var TIdxHasChanged=false;
		var motorCharsHasChanged=false;
		var movCalibHasChanged=false;
		var emailPwdChanged=false;
		var showAllTabs=window.location.href.startsWith('file');
		var getStatusInterval;
		var dataTempSensorsID=null;
		const NoOfMaxSensors = 34;
		var stmInit = 0;
		const cfgVCKiCol= 12;
		var getFSIntervalID = null;
		var loopGetFSCnt=0;
		var valveTempsExists = false;
		var valveMqttExists = false;
		var heatControl = null;
		var anyValveControlEnabled=false;
		var stmLoaded=false;
		var activeSetValvesDisplay = "none";
		var reconnectMQTT=false;
		var windowImageObjects = [null,null,null,null,null,null,null,null,null,null,null,null];
	    const tabImageSrc = ["","warning_yellow.png","warning_red.png"];

		// Get the modal
		var modal = id("pwdModal");
		// Get the <span> element that closes the modal
		var span = document.getElementsByClassName("close")[0];
				
		/* Toggle between adding and removing the "responsive" class to topNav when the user clicks on the icon */
		function resptopNav() {
			var x = id("mytopNav");
			if (x.className === "topNav") {
				x.className += " responsive";
			} else {
				x.className = "topNav";
			}
		}
		
		function showThisTab(pageName)
		{
			let showTab = (pageName=="Home") || (pageName=="About") || (pageName=="Status") || showAllTabs;
			return showTab
		}
		
		function showAllTabsNow ()
		{
			let tabLinks = document.getElementsByClassName("tabLink");
			for (i = 0; i < tabLinks.length; i++) {
				if ((showThisTab(tabLinks[i].name)))
				{
					tabLinks[i].style.display = "block";
				} else 
				{
					tabLinks[i].style.display = "none";
				}
			}
		}
		
		function openPage(pageName,elmnt,color) {
			let i, tabContent, tabLinks;	
			localStorage.pageId=elmnt.id;
			let thisUrl = new URL(elmnt.href);
			localStorage.pageUrl=thisUrl.hash;
			tabContent = document.getElementsByClassName("tabContent");
			for (i = 0; i < tabContent.length; i++) {
				tabContent[i].style.display = "none";
			}
			tabLinks = document.getElementsByClassName("tabLink");
			for (i = 0; i < tabLinks.length; i++) {
				tabLinks[i].style.backgroundColor = "";
			}
			if (showThisTab(pageName)===true) {
				id(pageName).style.display = "block";
				elmnt.style.backgroundColor = color;
			}
		}
				
				
		function _isContains(json, keyname) {
			return Object.keys(json).some(key => {
				return typeof json[key] === 'object' ? 
				_isContains(json[key], keyname, value) : key === keyname;
			});
		}
		
		function show_hide_column(tableId,col_no, do_show) {
		   	let tbl = id(tableId);
		   	for (i=0;i<tbl.rows.length;i++) {
		   		let thiscell = tbl.rows[i].cells[col_no];
				if (do_show===true)
					thiscell.classList.remove('hide');
				else
					thiscell.classList.add('hide');
		  	 }
		}
		

		function disable_enable_ValvesCfg (doDisable) {
			id("valvesDetect").disabled=doDisable;
			id("cfgValvesTableFieldSet1").disabled=doDisable;
			id("cfgValvesTableFieldSet2").disabled=doDisable;
			id("valvesStartCalib").disabled=doDisable;
			id("valvesAssembly").disabled=doDisable;
		}

		window.onhashchange = function() { 
			 //code  
			 if(window.location.hash) {
			  //var hash = window.location.hash.substring(1); //Puts hash in variable, and removes the # character
			  //console.log ('hash changed ='+window.location.hash+': '+hash);
			  //console.log ('hash ='+localStorage.pageUrl+': '+window.location.hash);
			  if (localStorage.pageUrl!=null) {
				if (localStorage.pageUrl!=window.location.hash) {
					if (window.location.hash=="#home") id("defaultOpen").click();
					else {
						if (window.location.hash.indexOf('#') !== -1) {
							let thisOpenId = window.location.hash.substring(1)+'Open';
							id(thisOpenId).click();
							//console.log ('OpenId  '+ thisOpenId);
						}
					}
				  //console.log ('hash now changed ='+localStorage.pageUrl+': '+window.location.hash);
				 }
				} else id("defaultOpen").click();
		  
			}
		}

		window.onload = async function() {
			await OnStart();
		}
		
		async function OnStart() {
			stmLoaded=false;
			disable_enable_ValvesCfg(true);
			fillTZList();
			await getSystemConfig();
			makeTempsTable(0);
			makeCfgValvesTable();
			makeValvesControlTable();
			makeCfgTempTable();
			await getValvesStatus();
			await getSystemInfo();
			await getSystemDynInfo();
			await getNetInfo();
			await getNetConfig();
			await getProtConfig();
			await getMsgConfig();
			await getTempsConfig();
			await getValvesConfig();
			await getValvesControlConfig();
			
			
			await getFSDir();
			getStatusInterval = window.setInterval(await getStatus, 2000);
			generateOnClick();
			showAllTabsNow();
			if (localStorage.pageId!=null) {
			if (id(localStorage.pageId)!=null) 
				id(localStorage.pageId).click();
		  	else id("defaultOpen").click();
			} else id("defaultOpen").click();
		}		
		
		async function loadStmData() {
			await getMotorConfig();
			await getTempSensorsID();
			await getTempsStatus();
			await getSystemInfo();
			await getValvesConfig();
		}
				
		async function checkLogin() {
			let login = {};
			login.user = id("dialogUserInput").value;
			login.pwd = id("dialogPwdInput").value;
			res = await postJson("auth",JSON.stringify(login));
			switch (res.auth) {
				case 0 : alert ("User name and password wrong"); break;
				case 1 : alert ("User name wrong"); break;
				case 2 : alert ("Password wrong"); break;
				case 3 : {	
							showAllTabs= true;
							showAllTabsNow();
							activeSetValvesDisplay = "block";
							id('activeSetValves').style.display="block";
							break;
						 }
			}
		}
				
		function setAllInputsDisabled (value) {
			var inputs = document.querySelectorAll(['input','select']);
			inputs.forEach(el => {
			   el.disabled=value;
			});
		}

		function ValidateIPaddress(inputText) {
			var ipformat = /^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;
			if (inputText.value.match(ipformat)) {
			  document.form1.text1.focus();
			  return true;
			} else {
			  alert("You have entered an invalid IP address!");
			  document.form1.text1.focus();
			  return false;
			}
		}
		
		function checkIfTempExists(valvesJson) {
			for (let row=0; row<valvesJson.length; row++) { 
				if ('temp1' in valvesJson[row]) return true;
				if ('temp2' in valvesJson[row]) return true;
			}	
			return false;
		}

		function checkIfMqttExists(valvesJson) {
			for (let row=0; row<valvesJson.length; row++) { 
				if ('tTarget' in valvesJson[row]) return true;
				if ('tValue' in valvesJson[row]) return true;
			}	
			return false;
		}


		function makeValvesTable(valvesJson) {
			const valvesTable = id('valvesTable');
			valvesTable.innerHTML="";
			let columnsize = 11;
			valveTempsExists=checkIfTempExists(valvesJson);
			if (valveTempsExists===true) {
				columnsize+=2;
			}
			valveMqttExists = checkIfMqttExists(valvesJson);
			if (valveMqttExists===true) {
				columnsize+=2;
			}
			for (let row=0; row<valvesJson.length+1; row++) { 
				const thisRow = valvesTable.insertRow(0);
				for (let i = 0; i < columnsize; i++) {
					cell = thisRow.insertCell();
					if ((i==2) || (i==3)) {
						cell.style.width = '20px';
					}
					if (i==4) {
						cell.style.width = '130px';
					}
				}
			}
			for (row=1;row<valvesJson.length+1;row++) {
				let thiscell = valvesTable.rows[row].cells[4];
				let el = document.createElement('img');
				el.setAttribute('name', 'windowImg' + row);
				el.setAttribute('id', 'windowImg' + row);
				el.setAttribute('style','height:30px;');
				el.className = "alignTabCellImgState";
				thiscell.appendChild(el);
				
				el = document.createElement('div');
				el.className = "alignTabCellState";
				el.appendChild(document.createTextNode(''));
				windowImageObjects[row-1] = el;
				thiscell.appendChild(el);

				thiscell = valvesTable.rows[row].cells[5];
				el = document.createElement('input');
				el.setAttribute('type', 'number');
				el.setAttribute('name', 'setValveP' + row);
				el.setAttribute('id', 'setValveP' + row);
				el.setAttribute('size', '3');
				el.setAttribute('maxlength' , '3');
				el.setAttribute('min' , '0');
				el.setAttribute('max' , '100');
				el.setAttribute('style','height:15px');
				el.setAttribute('readonly','true');
				
				thiscell.appendChild(el);
				thiscell = valvesTable.rows[row].cells[6];
				el = document.createElement('input');
				el.setAttribute('type', 'button');
				el.setAttribute('name', 'setValveButton-' + valvesJson[row-1].idx);
				el.setAttribute('id', 'setValveButton-' + row);
				el.setAttribute('style','height:20px;width:35px;visibility:hidden;');
				el.setAttribute('value', 'Set');
				el.setAttribute('onclick','setValve(this);');
				thiscell.appendChild(el);
				valvesTable.rows[row].cells[0].innerHTML = row;
				thiscell.classList.add('hide');
			}
			let thiscell = valvesTable.rows[0].cells[6];
			thiscell.classList.add('hide');
			valvesTable.rows[0].cells[0].textContent = 'No';
			valvesTable.rows[0].cells[1].textContent = 'Name';
			valvesTable.rows[0].cells[2].textContent = '%';
			valvesTable.rows[0].cells[3].textContent = 'mA';
			valvesTable.rows[0].cells[4].textContent = 'State';
			valvesTable.rows[0].cells[5].innerHTML = 'Target %';
			valvesTable.rows[0].cells[7].innerHTML = 'Moves';
			valvesTable.rows[0].cells[8].innerHTML = 'Open Count';
			valvesTable.rows[0].cells[9].innerHTML = 'Close Count';
			valvesTable.rows[0].cells[10].innerHTML = 'Dead Count';
			let colIdx=11;
			if (valveTempsExists===true) {
				valvesTable.rows[0].cells[colIdx++].innerHTML = 'Temp1';
				valvesTable.rows[0].cells[colIdx++].innerHTML = 'Temp2';
			}
			if (valveMqttExists===true) {
				valvesTable.rows[0].cells[colIdx++].innerHTML = 'tTarget';
				valvesTable.rows[0].cells[colIdx].innerHTML = 'tValue';
			}
			thiscell = valvesTable.rows[0].cells[5];
			el = document.createElement('input');
			el.setAttribute('type', 'checkbox');
			el.setAttribute('name', 'activeSetValves');
			el.setAttribute('id', 'activeSetValves');
			el.setAttribute('onclick','activateSetValves();');
			el.style.display=activeSetValvesDisplay; 
			thiscell.appendChild(el);
			
			if (localStorage.statusDetailed!=null) {
				id("status-detailed").checked=(localStorage.statusDetailed==="true");
			} else {
				id("status-detailed").checked=false;	
			}
			showStatusDetailed(id("status-detailed").checked);
		}
		
		function makeTempsTable(NoOfSensors) {
			const tempsTable = id('tempsTable');			
			while (tempsTable.rows.length>0) { 
					tempsTable.deleteRow(0);
			}
			for (row=0; row<NoOfSensors+1; row++) { 
				const thisRow = tempsTable.insertRow(0);
				
				for (let i = 0; i < 3; i++) {
					cell = thisRow.insertCell();
					cell.innerHTML = '--';
					if (i==2) cell.setAttribute('style','width:60px;');	
				}
			}
			for (let row=1;row<NoOfSensors+1;row++) tempsTable.rows[row].cells[0].innerHTML = row;
			tempsTable.rows[0].cells[0].textContent = 'No';
			tempsTable.rows[0].cells[1].textContent = 'Name';
			if (id("sysCfg-CF").selectedIndex==0)
				tempsTable.rows[0].cells[2].textContent = 'C';
			else
				tempsTable.rows[0].cells[2].textContent = 'F';
			if (NoOfSensors>12) tempsTable.style.height="430px";
		}
		
		function makeCfgValvesTable() {
			const cfgValvesTable = id('cfgValvesTable');	  
			for (let row=0; row<13; row++) { 
				const thisRow = cfgValvesTable.insertRow(0);
				for (let i = 0; i < 5; i++) {
					cell = thisRow.insertCell();
				}
			}
			for (row=1;row<13;row++) {
				cfgValvesTable.rows[row].cells[0].innerHTML = row;
				let thiscell = cfgValvesTable.rows[row].cells[1];
				let el = document.createElement('input');
				el.setAttribute('type', 'text');
				el.setAttribute('name', 'cfgVName' + row);
				el.setAttribute('id', 'cfgVName' + row);
				el.setAttribute('style','width:70px;');
				el.setAttribute('maxlength' , '10');
				thiscell.appendChild(el);
				thiscell = cfgValvesTable.rows[row].cells[2];
				el = document.createElement('input');
				el.setAttribute('type', 'checkbox');
				el.setAttribute('name', 'cfgVActive' + row);
				el.setAttribute('id', 'cfgVActive' + row);
				thiscell.appendChild(el);
				thiscell = cfgValvesTable.rows[row].cells[3];
				el = document.createElement('input');
				el.setAttribute('type', 'number');
				el.setAttribute('name', 'cfgVTIdx1-' + row);
				el.setAttribute('id', 'cfgVTIdx1-' + row);
				el.setAttribute('style','width:35px;');
				el.setAttribute('min','0');
				el.setAttribute('max','34');
				el.setAttribute('onchange', 'SetTIdxHasChanged()');
				thiscell.appendChild(el);
				thiscell = cfgValvesTable.rows[row].cells[4];
				el = document.createElement('input');
				el.setAttribute('type', 'number');
				el.setAttribute('name', 'cfgVTIdx2-' + row);
				el.setAttribute('id', 'cfgVTIdx2-' + row);
				el.setAttribute('style','width:35px;');
				el.setAttribute('min','0');
				el.setAttribute('max','34');
				el.setAttribute('onchange', 'SetTIdxHasChanged()');
				thiscell.appendChild(el);
			}
			cfgValvesTable.rows[0].cells[0].textContent = 'No';
			cfgValvesTable.rows[0].cells[1].textContent = 'Name';
			cfgValvesTable.rows[0].cells[2].textContent = 'Active';
			cfgValvesTable.rows[0].cells[3].textContent = 'TIdx1';
			cfgValvesTable.rows[0].cells[4].textContent = 'TIdx2';
		}
		
		function makeCfgTempTable() {
			const cfgTempTable = id('cfgTSensorTable');	  
			for (let row=0; row<NoOfMaxSensors+1; row++) { 
				const thisRow = cfgTempTable.insertRow(0);
				for (let i = 0; i < 5; i++) {
					cell = thisRow.insertCell();
				}
			}
			for (let row=1;row<NoOfMaxSensors+1;row++) {
				cfgTempTable.rows[row].cells[0].innerHTML = row;
				let thiscell = cfgTempTable.rows[row].cells[1];
				let el = document.createElement('input');
				el.setAttribute('type', 'text');
				el.setAttribute('name', 'cfgTName' + row);
				el.setAttribute('id', 'cfgTName' + row);
				el.setAttribute('style','width:80px;');
				el.setAttribute('maxlength' , '10');
				thiscell.appendChild(el);
				thiscell = cfgTempTable.rows[row].cells[2];
				el = document.createElement('input');
				el.setAttribute('type', 'checkbox');
				el.setAttribute('name', 'cfgTActive' + row);
				el.setAttribute('id', 'cfgTActive' + row);
				thiscell.appendChild(el);
				thiscell = cfgTempTable.rows[row].cells[3];
				el = document.createElement('input');
				el.setAttribute('type', 'text');
				el.setAttribute('name', 'cfgTOffset' + row);
				el.setAttribute('id', 'cfgTOffset' + row);
				el.setAttribute('size', '5');
				el.setAttribute('maxlength' , '5');
				el.setAttribute('style','width:40px;');
				thiscell.appendChild(el);
				thiscell = cfgTempTable.rows[row].cells[4];
				el = document.createElement('input');
				el.setAttribute('type', 'text');
				el.setAttribute('name', 'cfgTID' + row);
				el.setAttribute('id', 'cfgTID' + row);
				el.setAttribute('style','width:150px;');
				el.setAttribute('onchange', 'fillSensorIDSelect()');
				thiscell.appendChild(el);
				el = document.createElement('input');
				el.setAttribute('type', 'button');
				el.setAttribute('name', 'cfgTBtn' + row);
				el.setAttribute('id', 'cfgTBtn' + row);
				el.setAttribute('style','width:20px;');
				el.setAttribute('value','x');
				el.setAttribute('onclick', 'deleteID(this.id)');
				thiscell.appendChild(el);
				el = document.createElement('select');
				el.setAttribute('name', 'cfgTSel' + row);
				el.setAttribute('id', 'cfgTSel' + row);
				el.setAttribute('style','width:20px;');
				el.setAttribute('onchange', 'copyIDFromSelect(this.id)');
				thiscell.appendChild(el);
			}
			
			cfgTempTable.rows[0].cells[0].textContent = 'No';
			cfgTempTable.rows[0].cells[1].textContent = 'Name';
			cfgTempTable.rows[0].cells[2].textContent = 'Active';
			cfgTempTable.rows[0].cells[3].textContent = 'Offset';
			cfgTempTable.rows[0].cells[4].textContent = 'ID';
		}
		
		function makeValvesControlTable () {
			const valvesControlTable = id('cfgValvesControlTable');	  
			for (let row=0; row<13; row++) { 
				const thisRow = valvesControlTable.insertRow(0);
				for (let i = 0; i < 15; i++) {
					cell = thisRow.insertCell();
				}
			}
			for (row=1;row<13;row++) {
				valvesControlTable.rows[row].cells[0].innerHTML = row;
				
				thiscell = valvesControlTable.rows[row].cells[2];
				el = document.createElement('input');
				el.setAttribute('type', 'checkbox');
				el.setAttribute('name', 'cfgVCActive' + row);
				el.setAttribute('id', 'cfgVCActive' + row);
				thiscell.appendChild(el);

				thiscell = valvesControlTable.rows[row].cells[3];
				el = document.createElement('select');
				el.setAttribute('name', 'cfgVCAllow' + row);
				el.setAttribute('id', 'cfgVCAllow' + row);
				el.setAttribute('style','width:90px;');
				el.setAttribute('title','Select control allowed');
				let option = new Option('Heat/Cool', 0);
				el.options[0] = option;
				option = new Option('Heat', 1);
				el.options[1] = option;
				option = new Option('Cool', 2);
				el.options[2] = option;
				thiscell.appendChild(el);
				
				thiscell = valvesControlTable.rows[row].cells[4];
				el = document.createElement('select');
				el.setAttribute('name', 'cfgVCLink-' + row);
				el.setAttribute('id', 'cfgVCLink-' + row);
				el.setAttribute('style','width:60px;');
				option = new Option('none', 0);
				el.options[0] = option;
				let idx=1;
				for (i=1; i<13;i++) {
					if (i!=row) {
						option = new Option(i, i);
						el.options[idx] = option;
						idx++;
					}
				}
				el.setAttribute('onchange','setCfgVCLink(this);');		
				el.setAttribute('title','Select link for this valve');		
				thiscell.appendChild(el);
				
				thiscell = valvesControlTable.rows[row].cells[5];
				el = document.createElement('select');
				el.setAttribute('name', 'cfgVCValue' + row);
				el.setAttribute('id', 'cfgVCValue' + row);
				el.setAttribute('style','width:60px;');
				el.setAttribute('title','Select value source');
				option = new Option('mqtt', 0);
				el.options[0] = option;
				option = new Option('TIdx1', 1);
				el.options[1] = option;
				option = new Option('TIdx2', 2);
				el.options[2] = option;
				option = new Option('json', 3);
				el.options[3] = option;
				thiscell.appendChild(el);
				
				thiscell = valvesControlTable.rows[row].cells[6];
				el = document.createElement('select');
				el.setAttribute('name', 'cfgVCTarget' + row);
				el.setAttribute('id', 'cfgVCTarget' + row);
				el.setAttribute('style','width:60px;');
				el.setAttribute('title','Select target source');
				option = new Option('mqtt', 0);
				el.options[0] = option;
				option = new Option('json', 1);
				el.options[1] = option;
				thiscell.appendChild(el);
				
				thiscell = valvesControlTable.rows[row].cells[7];
				el = document.createElement('input');
				el.setAttribute('type', 'number');
				el.setAttribute('name', 'cfgVCXp' + row);
				el.setAttribute('id', 'cfgVCXp' + row);
				el.setAttribute('style','width:50px;');
				el.setAttribute('min','0');
				el.setAttribute('title','Enter band (xp). Kp=100/xp');
				thiscell.appendChild(el);
				
				thiscell = valvesControlTable.rows[row].cells[8];
				el = document.createElement('input');
				el.setAttribute('type', 'number');
				el.setAttribute('name', 'cfgVCOffs' + row);
				el.setAttribute('id', 'cfgVCOffs' + row);
				el.setAttribute('style','width:50px;');
				el.setAttribute('title','Enter offset');
				thiscell.appendChild(el);
				
				thiscell = valvesControlTable.rows[row].cells[9];
				el = document.createElement('input');
				el.setAttribute('type', 'number');
				el.setAttribute('name', 'cfgVCTi' + row);
				el.setAttribute('id', 'cfgVCTi' + row);
				el.setAttribute('style','width:50px;');
				el.setAttribute('min','0');
				el.setAttribute('title','Enter integral time in seconds');
				thiscell.appendChild(el);
				
				thiscell = valvesControlTable.rows[row].cells[10];
				el = document.createElement('input');
				el.setAttribute('type', 'number');
				el.setAttribute('name', 'cfgVCTs' + row);
				el.setAttribute('id', 'cfgVCTs' + row);
				el.setAttribute('style','width:50px;');
				el.setAttribute('min','1');
				el.setAttribute('title','Enter sampling time in seconds');
				thiscell.appendChild(el);
				
				thiscell = valvesControlTable.rows[row].cells[11];
				el = document.createElement('select');
				el.setAttribute('name', 'cfgVCScheme-' + row);
				el.setAttribute('id', 'cfgVCScheme-' + row);
				el.setAttribute('style','width:90px;');
				option = new Option('dynamic ki', 0);
				el.options[0] = option;
				option = new Option('static ki', 1);
				el.options[1] = option;
				el.setAttribute('onclick','setCfgVCScheme(this);');
				el.setAttribute('title','Enter scheme for control calculation');
				thiscell.appendChild(el);
				
				thiscell = valvesControlTable.rows[row].cells[12];
				el = document.createElement('input');
				el.setAttribute('type', 'number');
				el.setAttribute('step', 'any');
				el.setAttribute('name', 'cfgVCKi' + row);
				el.setAttribute('id', 'cfgVCKi' + row);
				el.setAttribute('style','width:70px;');
				el.setAttribute('min','0');
				el.setAttribute('title','Value ki for constant integral control calculation');
				thiscell.appendChild(el);
				
				thiscell = valvesControlTable.rows[row].cells[13];
				el = document.createElement('input');
				el.setAttribute('type', 'number');
				el.setAttribute('name', 'cfgVCSZ' + row);
				el.setAttribute('id', 'cfgVCSZ' + row);
				el.setAttribute('style','width:50px;');
				el.setAttribute('min','0');
				el.setAttribute('max','99');
				el.setAttribute('title','Active zone (closed) of the valve (0-99%)');
				thiscell.appendChild(el);
				
				el = document.createElement('input');
				el.setAttribute('type', 'number');
				el.setAttribute('name', 'cfgVCEZ' + row);
				el.setAttribute('id', 'cfgVCEZ' + row);
				el.setAttribute('style','width:50px;');
				el.setAttribute('min','1');
				el.setAttribute('max','100');
				el.setAttribute('title','Active zone (opened) of the valve (1-100%)');
				thiscell.appendChild(el);

				thiscell = valvesControlTable.rows[row].cells[14];
				el = document.createElement('input');
				el.setAttribute('type', 'checkbox');
				el.setAttribute('name', 'cfgVCWindow' + row);
				el.setAttribute('id', 'cfgVCWindow' + row);
				el.setAttribute('onchange','setCfgVCWindow(this);');
				thiscell.appendChild(el);
			}
			let col=0;
			valvesControlTable.rows[0].cells[col++].textContent = 'No';
			valvesControlTable.rows[0].cells[col++].textContent = 'Name';
			valvesControlTable.rows[0].cells[col++].textContent = 'Active';
			valvesControlTable.rows[0].cells[col].textContent = 'Allow';
			valvesControlTable.rows[0].cells[col++].title = 'Select control allowed';
			valvesControlTable.rows[0].cells[col].textContent = 'Link';
			valvesControlTable.rows[0].cells[col++].title = 'Select link for this valve';
			valvesControlTable.rows[0].cells[col].textContent = 'Value';
			valvesControlTable.rows[0].cells[col++].title = 'Select value source for this valve';
			valvesControlTable.rows[0].cells[col].textContent = 'Target';
			valvesControlTable.rows[0].cells[col++].title = 'Select target source for this valve';
			valvesControlTable.rows[0].cells[col].textContent = 'Xp';
			valvesControlTable.rows[0].cells[col++].title = 'Enter band (xp). Kp=100/xp';
			valvesControlTable.rows[0].cells[col].textContent = 'Offset(%)';
			valvesControlTable.rows[0].cells[col++].title = 'Enter offset';
			valvesControlTable.rows[0].cells[col].textContent = 'Ti(s)';
			valvesControlTable.rows[0].cells[col++].title = 'Enter integral time in seconds';
			valvesControlTable.rows[0].cells[col].textContent = 'Ts(s)';
			valvesControlTable.rows[0].cells[col++].title = 'Enter sampling time in seconds';
			valvesControlTable.rows[0].cells[col].textContent = 'Scheme';
			valvesControlTable.rows[0].cells[col++].title = 'Enter scheme for control calculation';
			valvesControlTable.rows[0].cells[col].textContent = 'ki';
			valvesControlTable.rows[0].cells[col++].title = 'Value ki for constant integral control calculation';
			valvesControlTable.rows[0].cells[col].textContent = 'Active zone';
			valvesControlTable.rows[0].cells[col++].title = 'Active zone of the valve (0-100 %)';
			valvesControlTable.rows[0].cells[col].textContent = 'Window';
			valvesControlTable.rows[0].cells[col++].title = 'Activate window handling';
		}
		
		function showBrokerIP() {
			let x = id("protcfg-Broker");
			let div1=id("div-protcfg-Broker3");
			let select = id("protcfg-dataProt").selectedIndex;
			if (select === 0) {
				x.style.display = "none";
				div1.classList.remove("tabpframe");
			} else {
				x.style.display = "block";
				div1.classList.add("tabpframe");
			}
			id("protcfg-Broker1").style.display=x.style.display;
			id("protcfg-Broker2").style.display=x.style.display;
			id("protcfg-Broker21").style.display=x.style.display;
			id("protcfg-Broker3").style.display=x.style.display;
			

		}

		function showMinPublish() {
			let e = id("tr-minPubTime");
			if (id("protcfg-pubOnChange").checked) {
				e.style.display = "";
			} else {
				e.style.display = "none";
			}	
		}
		
		function showWifi() {
			let x = id("netcfg-wifi");
			let e = id("tr-rssi");
			let select = id("netcfg-EthWifi").selectedIndex;
			if (select === 1) {
				x.style.display = "none";
				e.style.display = "none";
			} else {
				x.style.display = "block";
				e.style.display = "";
			}
		}

		function showDHCP(select) {
			let x = id("netcfg-Tdhcp");
			if (select === 1) {
				x.style.display = "none";
			} else {
				x.style.display = "block";
			}
		}
		function showSyslogIP(){
			let x = id("netcfg-syslog-table");
			let select = id("netcfg-syslog-select").selectedIndex;
			if (select === 0) {
				x.style.display = "none";
			} else {
				x.style.display = "block";
			}
		}
		
		function fillTZList() {
			let tzDropDown = id('netcfg-tz');
			let i=0;
			for (const x in jsonTZ) {
				tzDropDown.options[i] = new Option(x, x, false, false);
				i++;
			}
		}

		function getTZCode() {
			let tzDropDown = id('netcfg-tz');
			let tz = tzDropDown.value;
			let tzCode = jsonTZ[tz];
			id('netcfg-tzCode').textContent = tzCode;
			return (tzCode);
		}	

		function showStatusDetailed(enabled) {
			let vt=id('divValvesTable');
			if (enabled) vt.setAttribute ("style", "grid-column : span 4;");
			else
			vt.setAttribute ("style", "grid-column : span 3;");
			show_hide_column('valvesTable',3, enabled);
			show_hide_column('valvesTable',7, enabled);
			show_hide_column('valvesTable',8, enabled);
			show_hide_column('valvesTable',9, enabled);
			show_hide_column('valvesTable',10, enabled);
		}

		function generateOnClick() {
			id("netcfg-EthWifi").onclick = function(){
				showWifi();
			}
			id("netcfg-dhcp").onclick = function(){
				showDHCP(id("netcfg-dhcp").selectedIndex);
			}
			id("netcfg-syslog-select").onclick = function(){
				showSyslogIP();
			}
			id("protcfg-dataProt").onclick = function(){
			  showBrokerIP();
			}
			id("valvesStartCalib").onclick = function(){
				valvesStartCalib();
			};
			id("valvesAssembly").onclick = function(){
				valvesAssembly();
			};
			id("valvesDetect").onclick = function(){
				valvesDetect();
			};
			id("setSysLog").onclick = function(){
				setSysLog();
			};
			id("setSysLog").onclick = async function(){
				if (confirm('Are you sure you want to set syslog server ?')) {
					await postSysLogCfg();
					await postCmd('{"action":"sysLogSave"}');
				}
			};
			id("factoryRestore").onclick = function(){
				factoryRestore();
			};
			id("resetConfig").onclick = function(){
				resetConfig();
			};
			id("sysReboot").onclick = function(){
				reboot();
			};
			id("saveConfig").onclick = function(){
				saveConfig();
			};
			id("update-WT32").onclick = function(){
				updateWT32();
			};
			id("update-STM32").onclick = function(){
				updateSTM32();
			};
			
			id("netcfg-WifiPwd").onchange = function(){
				WifiPwdHasChanged=true;
			};
			
			id("netcfg-UserPwd").onchange = function(){
				UserPwdHasChanged=true;
			};
			
			id("protcfg-Pwd").onchange = function(){
				brokerPwdHasChanged=true;
			};
			
			id("tempSensorScan").onclick = function(){
				scanTSensors();
			};
			
			id("login-button").onclick = function(){
				doLogin();
			};
			
			id("fileDelete").onclick = function(){
				fileDelete();
			};
			
			id("formatFS").onclick = function(){
				formatFS();
			};
			
			id ("vCfg-lowC").onchange = function (){
				motorCharsHasChanged=true;
			}
			id ("vCfg-highC").onchange = function (){
				motorCharsHasChanged=true;
			}
			id ("vCfg-StartOnPower").onchange = function (){
				motorCharsHasChanged=true;
			}
			id ("vCfg-noOfMinCount").onchange = function (){
				motorCharsHasChanged=true;
			}
			id ("vCfg-maxCalReps").onchange = function (){
				motorCharsHasChanged=true;
			}
			id ("vCfg-movCalib").onchange = function (){
				movCalibHasChanged=true;
			}
			id ("vCfg-hCalib").onchange = function (){
				movCalibHasChanged=true;
			}
			for (i=0;i<7;i++) {
				let thisID = "vCfg-d" + i;
				id (thisID).onchange = function (){
					movCalibHasChanged=true;
				}
			}
			id ("VCtrlConfigHeatControl").onchange = function (){
				id("VCtrlConfigParkPosition").disabled=id("VCtrlConfigHeatControl").selectedIndex!=3;
			}
			
			id ("protcfg-pubOnChange").onclick = function() {
				showMinPublish();
			}
			
			id("status-detailed").onchange = function() {
				let statusDetailed = id('status-detailed');
				let enabled = statusDetailed.checked;
				showStatusDetailed(enabled);
				localStorage.statusDetailed = enabled;
			}

			// When the user clicks on <span> (x), close the modal
			span.onclick = function() {
			  modal.style.display = "none";
			}
			
			id("dialogOk").onclick = function () {
				checkLogin();
				modal.style.display = "none";
			};
			id("dialogCancel").onclick = function () {
				modal.style.display = "none";
			};
			
			id("saveVCtrlConfig").onclick = async function(){
				if (confirm('Are you sure you want to save control settings ?')) {
					await postValvesControlCfg();
					await postCmd('{"action":"vCtrlSave"}');
					if (reconnectMQTT===true) {
						await postCmd('{"action":"mqttReconnect"}');
						reconnectMQTT=false;
					}
				}
			};
			id("msgCfg-PushOverParam").addEventListener("click", () => {
    			id("pushOverParameterDialog").showModal();
			});
			id("close-pushOverParameterDialog").addEventListener("click", () => {
    			id("pushOverParameterDialog").close();
			});
			id("test-pushOver").addEventListener("click", () => {
    			testPushOver();
			});
			id("msgCfg-emailParam").addEventListener("click", () => {
    			id("emailParameterDialog").showModal();
			});
			id("close-emailParameterDialog").addEventListener("click", () => {
    			id("emailParameterDialog").close();
			});
			id("cfgEmailPwd").addEventListener("change", () => {
    			emailPwdChanged=true;
			});
			
			id("test-email").addEventListener("click", () => {
    			testEmail();
			});

			id("protcfg-timeOutTSActive").addEventListener("change", () => {
				if (id("protcfg-timeOutTSActive").checked) {
					alert ("Caution : If this option is activated it is absolutely mandatory to ensure that the tValue is received within the time frame. Publish on change on server side is not recommended with this option");
				}
			});
		}
		
		async function testPushOver(){
			let testPO={};
			testPO.appToken = id("cfgPushOverAPIToken").value;
			testPO.userToken = id("cfgPushOverUserToken").value;
			testPO.title = id("cfgPushOverTitle").value;
			await postJson("testPO",JSON.stringify(testPO));
		}

		async function testEmail(){
			let testEmail = {};
			testEmail.active = id("MsgEmailCfg-Active").checked ? 1 : 0;
			testEmail.user = id("cfgEmailUser").value;
			//if (emailPwdChanged===true) 
			testEmail.pwd = id("cfgEmailPwd").value;
			testEmail.host = id("cfgEmailHost").value;
			testEmail.port = id("cfgEmailPort").value;
			testEmail.recipient = id("cfgEmailRecipient").value;
			testEmail.title = id("cfgEmailTitle").value;
			await postJson("testEmail",JSON.stringify(testEmail));
		}

		function SetTIdxHasChanged() {
			TIdxHasChanged=true;
		}
		
		function activateSetValves(){
			let checked=id("activeSetValves").checked ;
			if ((heatControl!=null) && (heatControl!=0) && (anyValveControlEnabled) && (checked)){
				alert ("#Control/Heat control is not set to manual. Valve may doesn't work properly");
			} 
			const valvesTable = id('valvesTable');
			const valvesCfgTable = id('cfgValvesTable');
			show_hide_column('valvesTable',6, checked);
			for (i=1; i<valvesTable.rows.length;i++){
				let idx = valvesTable.rows[i].cells[0].textContent;
				let active=id('cfgVActive'+idx).checked; 
				id('setValveP'+i).readOnly=!(checked && active);
				if (checked && active) 
					id('setValveButton-'+i).style.visibility="visible"
				else
					id('setValveButton-'+i).style.visibility="hidden";
			}
		}
		
		function valvesStartCalib(){
			if (confirm('Are you sure you want to start calibration of valve ?')) {
				postCmd('{"action":"vCalib","valve":'+id("valvesAsmCalib-select").value+'}');
			}
		}
		
		function valvesAssembly(){
			if (confirm('Are you sure you want to set valve to assembly position ?')) {
				postCmd('{"action":"vAssembly","valve":'+id("valvesAsmCalib-select").value+'}');
			}
		}
		
		function valvesDetect(){
			if (confirm('Are you sure you want to detect valves ?')) {
				postCmd('{"action":"valvesDetect"}');
			}
		}
				
		async function fileDelete() {
			let fSelect = id("fileSelect");
			if (fSelect.value) {
				if (confirm('Are you sure you want to delete the file '+fSelect.value+' ?')) {
					await postCmd('{"action":"fDelete","file":"'+fSelect.value+'"}');
					getFSDir();
				}
			}
		}
		
		async function formatFS() {
			if (confirm('Are you sure you want to format the file system ?')) {
					postCmd('{"action":"clearFS"}');
					reloadDoc("http:/#home",15000,true);
			}
		}
		
		function generateFilesList (filesList) {
			let selectBox = id("fileSelect");
			let fileTabFrame=id("fileTabFrame")
			if (filesList.length==0) {
				fileTabFrame.style.display="none"; 
			} else {
				fileTabFrame.style.display="block"; 
				while (selectBox.options.length > 0) {                
					selectBox.remove(0);
				}     
				filesList.forEach((item) => {
					let newOption = new Option(item.fName,item.fName);
					selectBox.add(newOption,undefined);
				});
			}
		}
		
		function scanTSensors(){
			if (confirm('Are you sure you want to scan temperature sensors ?')) {
				postCmd('{"action":"scanTempSensors"}');
				setTimeout(function() {
					getTempSensorsID();	
				},5000);
			}
		}

		function doLogin() {
			modal.style.display = "block";
		}
		
		function reloadDoc (path,timeOut,clear=false,reLoad=true) {
			if ((clear===true) && getStatusInterval) clearInterval(getStatusInterval);
			document.body.style.cursor = 'wait';
			id("spinner").classList.add("spinner");
			
			setTimeout(function() {
					location.assign(path);
					if (reLoad===true){
						location.reload(true);					
					}
					document.body.style.cursor = 'default';
					id("spinner").classList.remove("spinner");
				},timeOut);
		}
		
		function factoryRestore(){
			if (confirm('Are you sure you want to restore configuration to factory settings ?')) {
				postCmd('{"action":"restoreCfg"}');
				reloadDoc("http:/#home",4000,true);
			}
		}
		
		function resetConfig(){
			if (confirm('Are you sure you want to reset configuration to factory settings except network ?')) {
				postCmd('{"action":"resetCfg"}');
				reloadDoc("http:/#home",4000,true);
			}
		}
		
		function reboot(){
			if (confirm('Are you sure you want to reboot ?')) {
				postCmd('{"action":"reboot"}');
				reloadDoc("http:/#home",4000,true);
			}
		}
			
		async function saveConfig(){
			if (confirm('Are you sure you want to save configuration ?')) {
				if (!(await postNetCfg())) return;
				if (!(await postProtCfg())) return;
				await postMessengerCfg();
				await postSystemConfig();
				await postValvesCfg();
				await postValvesControlCfg();
				//await postTempsCfg(1,11);
				//await postTempsCfg(12,23);
				//await postTempsCfg(24,34);
				postTempsCfg(1,34);
				await postCmd('{"action":"saveCfg"}');
				WifiPwdHasChanged=false;
				UserPwdHasChanged=false;
				brokerPwdHasChanged=false;
				reloadDoc("http:/#home",4000,true);
			}
		}
		
		async function postSystemConfig() {
			let sysCfg = {};
			sysCfg.CF = id("sysCfg-CF").selectedIndex;
			sysCfg.station=id("sysCfg-StationName").value;
			await postJson("sysconfig",JSON.stringify(sysCfg));
		}
		
		async function postNetCfg() {
			var netCfg = {};
			netCfg.ethWifi = id("netcfg-EthWifi").selectedIndex;
			netCfg.dhcp = id("netcfg-dhcp").selectedIndex;
			netCfg.ip =	id("netcfg-ip").value;
			netCfg.mask = id("netcfg-mask").value;
			netCfg.gw =	id("netcfg-gw").value;
			netCfg.dns = id("netcfg-dns").value;
			netCfg.ssid = id("netcfg-WifiSSID").value;
			if (WifiPwdHasChanged===true) {
				netCfg.pwd = id("netcfg-WifiPwd").value;
				if (id("netcfg-WifiPwd").value!=id("netcfg-WifiPwd2").value) {
					alert ("Wifi password does not compare ! Please re-type");
					return (false);
				}
			}
			netCfg.userName = id("netcfg-UserName").value;
			if (UserPwdHasChanged===true) {
				netCfg.userPwd = id("netcfg-UserPwd").value;
				if (id("netcfg-UserPwd").value!=id("netcfg-UserPwd2").value) {
					alert ("User password does not compare ! Please re-type");
					return (false);
				}
			}
			netCfg.timeServer = id("netcfg-TimeServer").value;
			netCfg.tz = id("netcfg-tz").value;
			netCfg.tzCode = getTZCode(id("netcfg-tz").value);
			netCfg.syslogLevel=id("netcfg-syslog-select").selectedIndex;
			netCfg.syslogIp=id("netcfg-syslog-ip").value;
			netCfg.syslogPort=id("netcfg-syslog-port").value;
			WifiPwdHasChanged=false;
			UserPwdHasChanged=false;
			await postJson("netconfig",JSON.stringify(netCfg));
			return (true);
		}
		
		async function postProtCfg() {
			let protCfg = {};
			protCfg.prot = id("protcfg-dataProt").selectedIndex;
			if (id("protcfg-dataProt").selectedIndex==1) {
				protCfg.ip = id("protcfg-Ip").value;
				protCfg.port = id("protcfg-Port").value;
				protCfg.interval = id("protcfg-Interval").value;
				protCfg.publish = id("protcfg-Publish").value;
				protCfg.pubMinDelay = id("protcfg-pubMinDelay").value;
				protCfg.user = id("protcfg-User").value;
				protCfg.pubSeparate = id("protcfg-pubSeparate").checked ? 1 : 0;
				protCfg.pubAllTemps = id("protcfg-pubAllTemps").checked ? 1 : 0;
				protCfg.pubPathAsRoot = id("protcfg-pubPathAsRoot").checked ? 1 : 0;
				protCfg.pubUpTime = id("protcfg-pubUpTime").checked ? 1 : 0;
				protCfg.pubDiag = id("protcfg-pubDiag").checked ? 1 : 0;
				protCfg.pubOnChange = id("protcfg-pubOnChange").checked ? 1 : 0;
				protCfg.pubRetained = id("protcfg-pubRetained").checked ? 1 : 0;
				protCfg.pubPlainText = id("protcfg-pubPlainText").checked ? 1 : 0;
				protCfg.keepAliveTime = id("protcfg-keepAliveTime").value;
				protCfg.mqttTOTSActive= id("protcfg-timeOutTSActive").checked ? 1 : 0;
				protCfg.mqttTODSActive= id("protcfg-timeOutDSActive").checked ? 1 : 0;
				protCfg.mqttTO= id("protcfg-timeOutValue").value;
				protCfg.mqttToPos= id("protcfg-timeOutPosition").value;
			}
			if (brokerPwdHasChanged===true) {
				protCfg.pwd = id("protcfg-Pwd").value;
				if (id("protcfg-Pwd").value!=id("protcfg-Pwd2").value) {
					alert ("Broker password does not compare ! Please re-type");
					return (false);
				}
			}
			brokerPwdHasChanged=false;
			await postJson("protconfig",JSON.stringify(protCfg));
			return (true);
		}

		async function postMessengerCfg() {
			let msgCfg = {};
			let reason = {};
			reason.valveFailed = id("MsgCfg-ReasonValveFailed").checked ? 1 : 0;
			reason.valveBlocked = id("MsgCfg-ReasonValveBlocked").checked ? 1 : 0;
			reason.notDetect = id("MsgCfg-ReasonValveDetect").checked ? 1 : 0;
			reason.reset = id("MsgCfg-ReasonReset").checked ? 1 : 0;
			reason.ds18Failed = id("MsgCfg-ReasonDS18Failed").checked ? 1 : 0;
			reason.tValueFailed = id("MsgCfg-ReasontValueFailed").checked ? 1 : 0;
			reason.mqttTimeOut = id("MsgCfg-ReasonMQTT").checked ? 1 : 0;
			reason.mqttTimeOutTime = id("protcfg-timeOutMqtt").value;
			let PO = {};
			PO.active = id("MsgPOCfg-Active").checked ? 1 : 0;
			PO.appToken = id("cfgPushOverAPIToken").value;
			PO.userToken = id("cfgPushOverUserToken").value;
			PO.title = id("cfgPushOverTitle").value;
			let Email = {};
			Email.active = id("MsgEmailCfg-Active").checked ? 1 : 0;
			Email.user = id("cfgEmailUser").value;
			Email.pwd = id("cfgEmailPwd").value;
			Email.host = id("cfgEmailHost").value;
			Email.port = id("cfgEmailPort").value;
			Email.recipient = id("cfgEmailRecipient").value;
			Email.title = id("cfgEmailTitle").value;
			msgCfg.reason = reason;
			msgCfg.PO = PO;
			msgCfg.Email = Email;
			await postJson("msgconfig",JSON.stringify(msgCfg));
			return (true);
		}
		
		async function postValvesCfg() {
		//	await postChunkValvesCfg(1,4,true);
		//	await postChunkValvesCfg(5,8);
		//	await postChunkValvesCfg(9,12,false,true);
		await postChunkValvesCfg(1,12,true,true);
		}
		
		async function postChunkValvesCfg(chunkStart,chunkEnd,postMotor=false,postSetTempTdx=false) {
			const cfgValvesTable = id('cfgValvesTable');
			let valvesItemsCfg = [];
			for (let row = chunkStart; row<chunkEnd+1; row++) {
				let valveValues={};
				valveValues.no = row;
				valveValues.name = id('cfgVName'+row).value; 
				valveValues.active = id('cfgVActive'+row).checked  ? 1 : 0;
				if (TIdxHasChanged) {
					valveValues.tIdx1= id('cfgVTIdx1-'+row).value;
					valveValues.tIdx2= id('cfgVTIdx2-'+row).value;
				}
				valvesItemsCfg.push(valveValues);
			}
			let valvesCfg={};
			let valvesCalib={};
			let motor={};
			
			valvesCalib.hourOfCalib=id('vCfg-hCalib').value;
			let dCalib=0;	
			for (let i=0; i<7; i++) {
				let x = Number(id('vCfg-d'+i).checked);
				dCalib|=x<<i;
			}
			valvesCfg.valves=valvesItemsCfg;
			if (postMotor===true) {
				valvesCalib.dayOfCalib=dCalib;
				if (movCalibHasChanged===true){
					valvesCalib.cycles=id('vCfg-movCalib').value;
					valvesCfg.calib=valvesCalib;
				}
				if (motorCharsHasChanged===true) {
					if (id("vCfg-lowC").value<0.5) id("vCfg-lowC").value=0.5;
					if (id("vCfg-lowC").value>5) id("vCfg-lowC").value=5;
					if (id("vCfg-highC").value<0.5) id("vCfg-highC").value=0.5;
					if (id("vCfg-highC").value>5) id("vCfg-highC").value=5;
					
					motor.lowC=Math.round(id("vCfg-lowC").value*10);
					motor.highC=Math.round(id("vCfg-highC").value*10);
					motor.startOnPower=id("vCfg-StartOnPower").value;
					motor.noOfMinCount=id("vCfg-noOfMinCount").value;
					motor.maxCalReps= id("vCfg-maxCalReps").value;
					valvesCfg.motor=motor;
				}
			}
			if (postSetTempTdx===true) {
				let tempIdx={};
				tempIdx.set=1;
				valvesCfg.tempIdx=tempIdx;
			}
			await postJson("valvesconfig",JSON.stringify(valvesCfg));
		}
		
		async function postValvesControlCfg() {
			//await postChunkValvesControlCfg(1,3);
			//await postChunkValvesControlCfg(4,6);
			//await postChunkValvesControlCfg(7,9);
			//await postChunkValvesControlCfg(10,12);
			await postChunkValvesControlCfg(1,12);
		}
		
		async function postChunkValvesControlCfg(chunkStart,chunkEnd) {
			const cfgValvesControlTable = id('cfgValvesControlTable');
			let valvesItemsCfg = [];
			for (let row = chunkStart; row<chunkEnd+1; row++) {
				let valveValues={};
				valveValues.no = row;
				valveValues.active = id('cfgVCActive'+row).checked  ? 1 : 0;
				valveValues.allow = id('cfgVCAllow'+row).value;
				valveValues.window = id('cfgVCWindow'+row).checked  ? 1 : 0;
				valveValues.link = id('cfgVCLink-'+row).value;
				valveValues.vSource = id('cfgVCValue'+row).value;
				valveValues.tSource = id('cfgVCTarget'+row).value;
				valveValues.xp = id('cfgVCXp'+row).value;
				valveValues.offset = id('cfgVCOffs'+row).value;
				valveValues.ti = id('cfgVCTi'+row).value;
				valveValues.ts = id('cfgVCTs'+row).value;
			 	valveValues.scheme = id('cfgVCScheme-'+row).value;
				valveValues.ki = id('cfgVCKi'+row).value;
				valveValues.startAZ = id('cfgVCSZ'+row).value;
				valveValues.endAZ = id('cfgVCEZ'+row).value;
				valvesItemsCfg.push(valveValues);
			}
			let valvesControlCfg={};
			let commonValues={};
			commonValues.heatControl=id('VCtrlConfigHeatControl').selectedIndex;
			heatControl = commonValues.heatControl;
			commonValues.parkPosition=id('VCtrlConfigParkPosition').value;
			valvesControlCfg.common=commonValues;
			valvesControlCfg.valves=valvesItemsCfg;
			await postJson("valvesctrlconfig",JSON.stringify(valvesControlCfg));
		}
				
		async function postTempsCfg(chunkStart,chunkEnd) {
			const cfgTempsTable = id('cfgTSensorTable');
			let tempsItemsCfg = [];
			for (let row = chunkStart; row<chunkEnd+1; row++) {
				let tempValues={};
				tempValues.name = id('cfgTName'+row).value; 
				tempValues.id = id('cfgTID'+row).value; 
				tempValues.active = id('cfgTActive'+row).checked  ? 1 : 0;
				let f = id('cfgTOffset'+row).value.replace(/ /g, "");
				f  = f.replace(/,/g, '.');
				f = parseFloat(f).toFixed(1)
				tempValues.offset = parseFloat(f);
				tempsItemsCfg.push(tempValues);
			}
			let tempsCfg={};
			tempsCfg.temps=tempsItemsCfg;
			tempsCfg.chunkStart=chunkStart;
			tempsCfg.chunkEnd=chunkEnd;
			await postJson("tempsconfig",JSON.stringify(tempsCfg));
		}
		
		async function 	postSysLogCfg() {	
			let sysLogCfg = {};
			sysLogCfg.syslogLevel=id("netcfg-syslog-select").selectedIndex;
			sysLogCfg.syslogIp=id("netcfg-syslog-ip").value;
			sysLogCfg.syslogPort=id("netcfg-syslog-port").value;
			await postJson("sysLogCfg",JSON.stringify(sysLogCfg));
		}

		async function postCmd (cmd) {
			await postJson("cmd",cmd);
		}
		
		async function setValve(thisButton){
			const buttonName = thisButton.name;
			const buttonId= thisButton.id;
			let valveNo = buttonName.slice(buttonName.indexOf("-")+1);
			let valveRow=buttonId.slice(buttonId.indexOf("-")+1);
			const value = id('setValveP'+valveRow).value;
			if (value){
				let setThisValve = {};
				setThisValve.valve = valveNo;
				setThisValve.value = value;
				await postJson("setvalve",JSON.stringify(setThisValve));
			}
		}
		
		function setCfgVCScheme(thisLink){
			const linkId= thisLink.id;
			let linkNo = linkId.slice(linkId.indexOf("-")+1);
			let display = 'block';
			if (thisLink.value==0) {
				display = 'none';
			}  
			id('cfgVCKi'+linkNo).style.display=display;
		}		
		
		function setCfgVCLink(thisLink){
			const linkId= thisLink.id;
			let linkNo = linkId.slice(linkId.indexOf("-")+1);
			let display = 'block';
			if (thisLink.value>0) {
				display = 'none';
			}  
			id('cfgVCValue'+linkNo).style.display=display;
			id('cfgVCTarget'+linkNo).style.display=display;
			id('cfgVCXp'+linkNo).style.display=display;
			id('cfgVCOffs'+linkNo).style.display=display;
			id('cfgVCTi'+linkNo).style.display=display;
			id('cfgVCTs'+linkNo).style.display=display;
			id('cfgVCScheme-'+linkNo).style.display=display;
			id('cfgVCKi'+linkNo).style.display=display;
			id('cfgVCSZ'+linkNo).style.display=display;
			id('cfgVCEZ'+linkNo).style.display=display;
			id('cfgVCWindow'+linkNo).style.display=display;
			if (display=='block') setCfgVCScheme(id('cfgVCScheme-'+linkNo));
		}
				
		function setCfgVCWindow(thisLink){
			reconnectMQTT=true;
		}

		function checkVCScheme()
		{
			let kiStatics=false;
			for (let i=1;i<13;i++) {
				let vcScheme=id('cfgVCScheme-'+i);
				if (vcScheme.selectedIndex=1) kiStatics=true;
			}
			return (kiStatics);
		}
				
		async function getStatus() {
			await getSystemDynInfo();
			await getValvesStatus();
			await getTempsStatus();
		}
		
		function checkValvesConnected (valvesJson){
			const cfgValvesTable = id('cfgValvesTable');
			const cfgValvesControlTable = id('cfgValvesControlTable');
			for (let row = 1; row<13; row++) {
				cfgValvesTable.rows[row].cells[0].style.backgroundColor = "";
				cfgValvesControlTable.rows[row].cells[0].style.backgroundColor = "";
			}
			valvesJson.forEach(function(item, index){
				let thisState = item.state & 0x7f;
				if ((thisState!=5) && (thisState!=6)) {
					cfgValvesTable.rows[item.idx].cells[0].style.backgroundColor = "green";
					cfgValvesControlTable.rows[item.idx].cells[0].style.backgroundColor = "green";
				}
			});
		}
		
		function fillValvesTable (valvesJson) {
			const valvesTable = id('valvesTable');
			if ((valvesTable.rows.length != valvesJson.length+1) || (checkIfTempExists(valvesJson)!=valveTempsExists) || (checkIfMqttExists(valvesJson)!=valveMqttExists)) {
				makeValvesTable(valvesJson);
			}
			const States = ["---","idle","opens","closes","failed","unknown","no valve","full open","connected","blocked"];
			let thisImg=null;
			let statusWarning = 0;
			valvesJson.forEach(function(item, index){
				valvesTable.rows[index+1].cells[0].textContent = item.idx;	
				switch (item.controlActive) {
					case 0:
					case 2:
					case 4: 
					case 6:
					{
						valvesTable.rows[index+1].cells[0].style.backgroundColor="gray";
						valvesTable.rows[index+1].cells[0].style.color="white";
						break;
					}
					case 1:
					case 5: 
					{
						valvesTable.rows[index+1].cells[0].style.backgroundColor="yellow";
						valvesTable.rows[index+1].cells[0].style.color="blue";
						break;
					}
					case 3: {
						valvesTable.rows[index+1].cells[0].style.backgroundColor="green";
						valvesTable.rows[index+1].cells[0].style.color="white";
						break;
					}
					case 7: {
						valvesTable.rows[index+1].cells[0].style.backgroundColor="red";
						valvesTable.rows[index+1].cells[0].style.color="white";
						break;
					}
				}

				valvesTable.rows[index+1].cells[1].textContent = item.name;	
				valvesTable.rows[index+1].cells[2].textContent = item.pos;
				thisImg=id("windowImg"+(index+1));	
				if ('window' in item) {
					if (item.window===1) {	
						thisImg.src="window_open.png";	
					} else thisImg.src="window_close.png";	
				} else thisImg.src="window_gray.png";
				if (item.link>0) thisImg.src="blank.png";
				valvesTable.rows[index+1].cells[3].textContent = item.meanCur;
				if ('calibration' in item) {
					windowImageObjects[index].childNodes[0].nodeValue="calibration";
				} else 
					windowImageObjects[index].childNodes[0].nodeValue = States[item.state];
				
				switch (item.state) {
					case 4 :
					case 9 : {
						valvesTable.rows[index+1].cells[4].style.backgroundColor="red";
						valvesTable.rows[index+1].cells[4].style.color="white";
						statusWarning=2;
						break;
					}
					default : {
						if (item.cr>0) {
							valvesTable.rows[index+1].cells[4].style.backgroundColor="yellow";
							valvesTable.rows[index+1].cells[4].style.color="blue";
							statusWarning=1;
						} else {
							valvesTable.rows[index+1].cells[4].style.backgroundColor="gray";
							valvesTable.rows[index+1].cells[4].style.color="white";
						}
						break;
					}
				}
				
				valvesTable.rows[index+1].cells[7].textContent = item.moves;
				valvesTable.rows[index+1].cells[8].textContent = item.oc;
				valvesTable.rows[index+1].cells[9].textContent = item.cc;
				valvesTable.rows[index+1].cells[10].textContent = item.dc;
				let colIdx=11;
				if (valveTempsExists===true) {
					if (item.temp1) {
						valvesTable.rows[index+1].cells[colIdx].textContent = item.temp1;
						if (item.temp1==="failed") valvesTable.rows[index+1].cells[colIdx].style.backgroundColor="red"; else valvesTable.rows[index+1].cells[colIdx].style.backgroundColor="gray";
						colIdx++;
					}
					else valvesTable.rows[index+1].cells[colIdx++].textContent = "";

					if (item.temp2) {
						valvesTable.rows[index+1].cells[colIdx].textContent = item.temp2;
						if (item.temp2==="failed") valvesTable.rows[index+1].cells[colIdx].style.backgroundColor="red"; else valvesTable.rows[index+1].cells[colIdx].style.backgroundColor="gray";
						colIdx++;
					}
					else valvesTable.rows[index+1].cells[colIdx++].textContent = "";
				}
				if (valveMqttExists===true) {
					if ('tTarget' in item)
						valvesTable.rows[index+1].cells[colIdx++].textContent = item.tTarget;
					else valvesTable.rows[index+1].cells[colIdx++].textContent = "";
					if ('tValue' in item) {
						valvesTable.rows[index+1].cells[colIdx].textContent = item.tValue;
						if ('tValueFailed' in item) valvesTable.rows[index+1].cells[colIdx].style.backgroundColor="red"; 
						else  valvesTable.rows[index+1].cells[colIdx].style.backgroundColor="gray";
					}
					else valvesTable.rows[index+1].cells[colIdx].textContent = "";
				}

				if (!(id('activeSetValves').checked)) {
					id('setValveP'+(index+1)).value=item.targetPos;
				}
			});
			if (statusWarning == 0) id("statusImg").style.visibility="hidden"; else id("statusImg").style.visibility="visible";
			id("statusImg").src=tabImageSrc[statusWarning];
		}
		
		function fillCfgValvesTable (cfgValvesJson) {
			const cfgValvesTable = id('cfgValvesTable');
			id('vCfg-hCalib').value = cfgValvesJson.calib.hourOfCalib;
			let dCalib=0;	
			for (let i=0; i<7; i++) {
				dCalib=cfgValvesJson.calib.dayOfCalib & (1<<i);
				if (dCalib==0) id('vCfg-d'+i).checked=false; else id('vCfg-d'+i).checked=true; 
			}
			for (let row = 1; row<13; row++) {
				id('cfgVName'+row).value = cfgValvesJson.valves[row-1].name;
				id('cfgVActive'+row).checked = cfgValvesJson.valves[row-1].active;
				id('cfgVTIdx1-'+row).value = cfgValvesJson.valves[row-1].tIdx1;
				id('cfgVTIdx2-'+row).value = cfgValvesJson.valves[row-1].tIdx2;
				
			}
			fillAssemblyListBox (cfgValvesJson);
		}

		function fillAssemblyListBox (cfgValvesJson) {
			let AsmSelectBox= id("valvesAsmCalib-select");
			AsmSelectBox.options.length=0;
			let newOption = new Option("All",255);
			AsmSelectBox.add(newOption,undefined);

			for (let row = 1; row<13; row++) {
				if (cfgValvesJson.valves[row-1].active) {
					let newOption = new Option(cfgValvesJson.valves[row-1].name,row);
					AsmSelectBox.add(newOption,undefined);
				}
			}
		}

		function fillCfgMotorTable(cfgMotorJson) {
			id('vCfg-movCalib').value=cfgMotorJson.calib.cycles;
			id("vCfg-lowC").value=cfgMotorJson.motor.lowC/10;
			id("vCfg-highC").value=cfgMotorJson.motor.highC/10;
			id("vCfg-StartOnPower").value=cfgMotorJson.motor.startOnPower;
			id("vCfg-noOfMinCount").value=cfgMotorJson.motor.noOfMinCount;
			id("vCfg-maxCalReps").value=cfgMotorJson.motor.maxCalReps;
		}
		
		function fillCfgValvesControlTable (cfgValvesControlJson) {
			anyValveControlEnabled=false;
			const cfgValvesControlTable = id('cfgValvesControlTable');
			id ('VCtrlConfigHeatControl').selectedIndex=cfgValvesControlJson.common.heatControl;
			heatControl = cfgValvesControlJson.common.heatControl;
			id ('VCtrlConfigParkPosition').value=cfgValvesControlJson.common.parkPosition;
			id("VCtrlConfigParkPosition").disabled=id("VCtrlConfigHeatControl").selectedIndex!=3;
			for (let row = 1; row<13; row++) {
				cfgValvesControlTable.rows[row].cells[1].textContent = cfgValvesControlJson.valves[row-1].name;
				id('cfgVCActive'+row).checked = cfgValvesControlJson.valves[row-1].active;
				id('cfgVCAllow'+row).value = cfgValvesControlJson.valves[row-1].allow;
				id('cfgVCWindow'+row).checked = cfgValvesControlJson.valves[row-1].window;
				id('cfgVCLink-'+row).value = cfgValvesControlJson.valves[row-1].link;
				id('cfgVCValue'+row).value = cfgValvesControlJson.valves[row-1].vSource;
				id('cfgVCTarget'+row).value = cfgValvesControlJson.valves[row-1].tSource;
				id('cfgVCXp'+row).value = cfgValvesControlJson.valves[row-1].xp;
				id('cfgVCOffs'+row).value = cfgValvesControlJson.valves[row-1].offset;
				id('cfgVCTi'+row).value = cfgValvesControlJson.valves[row-1].ti;
				id('cfgVCTs'+row).value = cfgValvesControlJson.valves[row-1].ts;
				id('cfgVCScheme-'+row).value= cfgValvesControlJson.valves[row-1].scheme;
				id('cfgVCKi'+row).value= cfgValvesControlJson.valves[row-1].ki;
				id('cfgVCSZ'+row).value= cfgValvesControlJson.valves[row-1].startAZ;
				id('cfgVCEZ'+row).value= cfgValvesControlJson.valves[row-1].endAZ;
				setCfgVCLink(id('cfgVCLink-'+row));
				if (cfgValvesControlJson.valves[row-1].active==1) anyValveControlEnabled=true;
			}
		}
		
		function fillTempsTable (tempsJson) {
			const tempsTable = id('tempsTable');
			const tempStatusTabFrame = id("tempStatusTabFrame")
			if (tempsJson.length==0) {
				tempStatusTabFrame.style.display="none";
			} else {
				tempStatusTabFrame.style.display="block";
				if (tempsJson.length!=tempsTable.rows.length-1) {
					makeTempsTable(tempsJson.length);
				}
				tempsJson.forEach(function (item, index) {            
					tempsTable.rows[index+1].cells[1].textContent = item.name;
					if (item.temp==="failed") tempsTable.rows[index+1].cells[2].style.backgroundColor="red"; else tempsTable.rows[index+1].cells[2].style.backgroundColor="gray";
					tempsTable.rows[index+1].cells[2].textContent = item.temp;
				});
			}
		}
		
		function fillCfgTempsTable (cfgTempsJson) {
			const cfgTempsTable = id('cfgTSensorTable');
			for (let row = 1; row<NoOfMaxSensors+1; row++) {				
				id('cfgTName'+row).value = cfgTempsJson[row-1].name;
				id('cfgTActive'+row).checked = cfgTempsJson[row-1].active;
				id('cfgTOffset'+row).value = cfgTempsJson[row-1].offset;
				id('cfgTID'+row).value = cfgTempsJson[row-1].id;
			}
		}
		
		function findTID(TId){
			let retVal=false;
			if (dataTempSensorsID) {
				dataTempSensorsID.forEach(function(item) {
					if (TId===item.id) {
						retVal=true;
						return;
					}
				});
			}
			return (retVal);
		}
		
		function checkCfgTempsID () {
			var result=true;
			for (let row = 1; row<NoOfMaxSensors+1; row++) {
				let TID = id('cfgTID'+row);
				if (TID.value!="") {
					if (!findTID(TID.value)) {
						TID.style.backgroundColor = "red";
						result=false;
					 } else TID.style.backgroundColor = "";
				}
			}
			return result;
		}
		
		function findID (SensorID) {
			for (let row = 1; row<NoOfMaxSensors+1; row++) {	
				let selectElement=id('cfgTID'+row);
				if (selectElement.value===SensorID) return (true);
			}
			return (false);
		}
		
		function deleteID (thisButton) {
			const button=id(thisButton);
			let thisRow=button.id.slice(7);
			const thisInput=id('cfgTID' + thisRow);
			thisInput.value="";	
			fillSensorIDSelect();
		}
		
		function copyIDFromSelect (thisSelect) {
			const select=id(thisSelect);
			let thisRow=select.id.slice(7);
			const thisInput=id('cfgTID' + thisRow);
			thisInput.value=select.value;
			fillSensorIDSelect();
		}
		
		function fillSensorIDSelect() {
			for (let row = 1; row<NoOfMaxSensors+1; row++) {	
				let selectElement=id('cfgTSel'+row);
				while (selectElement.options.length > 0) {                
					selectElement.remove(0);
				}   
				let option = new Option(' -Select-', 0);
				selectElement.options[0] = option;
				let i=1;
				dataTempSensorsID.forEach(function (item, index) { 
					if (!findID(item.id)) {
						option = new Option(item.id, item.id);
						selectElement.options[i] = option;
						i++;
					}
				});
			}
			checkCfgTempsID();
		}
		
		async function getSystemInfo() {
			const dataSystemInfo=await getJson("sysinfo");
			if (dataSystemInfo) {
				id("sysWt32-Version").textContent = dataSystemInfo["wt32version"];
				id("wt32-ChipModel").textContent = dataSystemInfo["wt32ChipModel"];
				id("wt32-ChipCores").textContent = dataSystemInfo["wt32ChipCores"];
				id("wt32-ChipVersion").textContent = dataSystemInfo["wt32ChipCoreRev"];
				id("wt32-Sketch").textContent = dataSystemInfo["wt32Sketch"]+" bytes";
			 	id("wt32-FlashUsed").textContent = dataSystemInfo["wt32FlashUsed"]+" %";
				id("wt32-ChipStack").textContent = dataSystemInfo["wt32ChipStack"]+" bytes";
				id("sysSTM32-Version").textContent = dataSystemInfo["stm32version"];
				id("sysSTM32-ChipId").textContent = dataSystemInfo["stm32ChipId"];
			}
		}
		
		async function getSystemDynInfo() {
			const dataSystemDynInfo=await getJson("sysdyninfo");
			if (dataSystemDynInfo) {
				id("locTime").textContent = dataSystemDynInfo["locTime"];
				
				if (dataSystemDynInfo["sntpActive"]==0) {
					id("calibDate").style = "display:none;";
					id ("cfgValvesTableFieldSet1").style = "height:3em;";
				}
				else {
					id("calibDate").style = "display:block;";
					id ("cfgValvesTableFieldSet1").style = "height:17em;";
				}
				id("upTime").textContent = dataSystemDynInfo["upTime"];
				id("heap").textContent = dataSystemDynInfo["heap"];
				id("min-heap").textContent = dataSystemDynInfo["minheap"];
				id("rssi").textContent = dataSystemDynInfo["wifirssi"];
				if (_isContains(dataSystemDynInfo, "brokerConnected")) {
					id("net-broker").style.display="block";
					id("net-broker-status").textContent=dataSystemDynInfo["brokerConnected"] ? "Connected" : "Not connected"; 
				}
				
				id("net-sntp-status").textContent=dataSystemDynInfo["sntpActive"] ? dataSystemDynInfo["sntpReachable"] ? "Connected" : "Not connected" : "Not defined"; 	

				id ("miscStatusHC").textContent=id("VCtrlConfigHeatControl").options[dataSystemDynInfo["heatControl"]].value;
				id("miscStatusLC").textContent=dataSystemDynInfo["lastCalib"];
				let newStmInit=dataSystemDynInfo["stmInit"];
				disable_enable_ValvesCfg((newStmInit!=2) || (!stmLoaded));
				if (newStmInit!=stmInit) {
					stmInit=newStmInit;
					if (stmInit===2) {
						setTimeout(async function() {
							await loadStmData();
							stmLoaded=true;
						},5000);
					}
				}
				if (!stmLoaded) {
					id("spinner-Config").classList.add("spinner");
				} else {
					id("spinner-Config").classList.remove("spinner");
				}
				if (!checkCfgTempsID()) {
					await getTempSensorsID();
				}
			}
		}
		
		
		async function getSystemConfig() {
			const dataSysCfg=await getJson("sysconfig");
			if (dataSysCfg) {
				id("sysCfg-CF").selectedIndex = dataSysCfg["CF"];
				id("sysCfg-StationName").value=dataSysCfg["station"];
				id("sysStation").textContent=dataSysCfg["station"];
			}
		}
		
		async function getNetInfo() {
			const dataNet=await getJson("netinfo");
			if (dataNet) {
				id("net-EthWifi").textContent = dataNet["ethWifi"] ? "Wifi" : "Eth";
				id("net-dhcp").textContent = dataNet["dhcp"] ? "On" : "Off";
				id("net-ip").textContent = dataNet["ip"];
				id("net-MAC").textContent = dataNet["mac"];
				id("net-mask").textContent = dataNet["mask"];
				id("net-gw").textContent = dataNet["gw"];
				id("net-dns").textContent = dataNet["dns"];
			}
		}
		
		async function getNetConfig() {
			const dataNetConfig=await getJson("netconfig");
			if (dataNetConfig) {
				id("netcfg-EthWifi").selectedIndex = dataNetConfig["ethWifi"];
				id("netcfg-dhcp").selectedIndex = dataNetConfig["dhcp"];
				id("netcfg-ip").value = dataNetConfig["ip"];
				id("netcfg-mask").value = dataNetConfig["mask"];
				id("netcfg-gw").value = dataNetConfig["gw"];
				id("netcfg-dns").value = dataNetConfig["dns"];
				id("netcfg-WifiSSID").value = dataNetConfig["ssid"];
				id("netcfg-UserName").value = dataNetConfig["userName"];
				id("netcfg-TimeServer").value = dataNetConfig["timeServer"];
				id("netcfg-tz").value = dataNetConfig["tz"];
				id("netcfg-tzCode").textContent = dataNetConfig["tzCode"];
				id("netcfg-syslog-select").selectedIndex=dataNetConfig.syslogLevel;
				id("netcfg-syslog-ip").value=dataNetConfig.syslogIp;
				id("netcfg-syslog-port").value=dataNetConfig.syslogPort;
				showWifi();
				showDHCP(dataNetConfig["dhcp"]);
				showSyslogIP();
				if (dataNetConfig["userName"]==="") {
					activeSetValvesDisplay = "block";
					id('activeSetValves').style.display="block";
					showAllTabs=true;
					showAllTabsNow();
				} else id("login-button").style.display = "block";
			}
		}
		
		async function getProtConfig() {
			const dataProtConfig=await getJson("protconfig");
			if (dataProtConfig) {
				id("protcfg-dataProt").selectedIndex = dataProtConfig["prot"];
				id("protcfg-Ip").value = dataProtConfig["ip"];
				id("protcfg-Port").value = dataProtConfig["port"];
				id("protcfg-Interval").value = dataProtConfig["interval"];
				id("protcfg-Publish").value = dataProtConfig["publish"];
				id("protcfg-pubMinDelay").value = dataProtConfig["pubMinDelay"];
				id("protcfg-User").value = dataProtConfig["user"];
				id("protcfg-pubSeparate").checked = dataProtConfig["pubSeparate"];
				id("protcfg-pubAllTemps").checked = dataProtConfig["pubAllTemps"];
				id("protcfg-pubPathAsRoot").checked = dataProtConfig["pubPathAsRoot"];
				id("protcfg-pubUpTime").checked = dataProtConfig["pubUpTime"];
				id("protcfg-pubDiag").checked = dataProtConfig["pubDiag"];
				id("protcfg-pubOnChange").checked = dataProtConfig["pubOnChange"];
				id ("protcfg-pubPlainText").checked = dataProtConfig["pubPlainText"];
				id ("protcfg-pubRetained").checked = dataProtConfig["pubRetained"];
				id("protcfg-keepAliveTime").value = dataProtConfig["keepAliveTime"];
				id("protcfg-timeOutTSActive").checked=dataProtConfig["mqttTOTSActive"];
				id("protcfg-timeOutDSActive").checked=dataProtConfig["mqttTODSActive"];
				id("protcfg-timeOutValue").value=dataProtConfig["mqttTO"];
				id("protcfg-timeOutPosition").value=dataProtConfig["mqttToPos"];

				showBrokerIP();
				showMinPublish();
			}
		}
		async function getMsgConfig() {
			const dataMsgConfig=await getJson("msgconfig");
			if (dataMsgConfig) {
				id ("MsgCfg-ReasonValveFailed").checked = dataMsgConfig.reason.valveFailed;
				id ("MsgCfg-ReasonValveBlocked").checked = dataMsgConfig.reason.valveBlocked;
				id ("MsgCfg-ReasonValveDetect").checked = dataMsgConfig.reason.notDetect;
				id ("MsgCfg-ReasonReset").checked = dataMsgConfig.reason.reset;
				id("MsgCfg-ReasontValueFailed").checked = dataMsgConfig.reason.tValueFailed;
				id("MsgCfg-ReasonDS18Failed").checked = dataMsgConfig.reason.ds18Failed;
				id ("MsgCfg-ReasonMQTT").checked = dataMsgConfig.reason.mqttTimeOut;
				id ("protcfg-timeOutMqtt").value = dataMsgConfig.reason.mqttTimeOutTime;
				id("MsgPOCfg-Active").checked = dataMsgConfig.PO.active;
				id("cfgPushOverAPIToken").value = dataMsgConfig.PO.appToken;
				id("cfgPushOverUserToken").value = dataMsgConfig.PO.userToken;
				id("cfgPushOverTitle").value = dataMsgConfig.PO.title;
				
				id("MsgEmailCfg-Active").checked = dataMsgConfig.Email.active;
				id("cfgEmailUser").value = dataMsgConfig.Email.user;
				id("cfgEmailPwd").value = dataMsgConfig.Email.pwd;
				id("cfgEmailHost").value = dataMsgConfig.Email.host;
				id("cfgEmailPort").value = dataMsgConfig.Email.port;
				id("cfgEmailRecipient").value = dataMsgConfig.Email.recipient;
				id("cfgEmailTitle").value = dataMsgConfig.Email.title;

				return (true);
			}
		}
		
		async function getValvesConfig() {
			const dataValvesConfig=await getJson("valvesconfig");
			if (dataValvesConfig) fillCfgValvesTable(dataValvesConfig);
		}
		
		async function getMotorConfig() {
			const dataMotorConfig=await getJson("motorconfig");
			if (dataMotorConfig) fillCfgMotorTable(dataMotorConfig);
		}

		async function getValvesControlConfig() {
			const dataValvesControlConfig=await getJson("valvesctrlconfig");
			if (dataValvesControlConfig) fillCfgValvesControlTable(dataValvesControlConfig);
		}
		
		async function getValvesStatus() {
			const dataValvesStatus=await getJson("valves");
			if (dataValvesStatus) {
				fillValvesTable(dataValvesStatus.valves);
				checkValvesConnected (dataValvesStatus.valves);
			}
		}
		
		async function getTempsConfig() {
			const dataTempsConfig=await getJson("tempsconfig");
			if (dataTempsConfig) fillCfgTempsTable(dataTempsConfig);
			checkCfgTempsID();
		}
		
		async function getTempSensorsID() {
			const thisDataTempSensorsID=await getJson("tempsensorsid");
			if (thisDataTempSensorsID) {
				dataTempSensorsID = thisDataTempSensorsID;
				fillSensorIDSelect(); 
			}
		}
		
		async function getTempsStatus() {
			const dataTempsStatus=await getJson("temps");
			if (dataTempsStatus) fillTempsTable(dataTempsStatus);
		}
			
		async function updateWT32() {
			reloadDoc("http:/update",100,false,false);
		}	
			
		async function updateSTM32() {
			reloadDoc("http:/stmupdate",100,false,false);
		}	
		
		async function getFSDir() {
			await this.postCmd('{"action":"getFS"}');
			if (getFSIntervalID==null) {
				loopGetFSCnt=0;
				getFSIntervalID = setInterval(async function() {
					loopGetFSCnt++;
					let fsDir= await this.getJson("fsdir");
					if ((fsDir) || (loopGetFSCnt>=30)) {
						if (fsDir) generateFilesList (fsDir);	
						clearInterval(getFSIntervalID);
						getFSIntervalID = null;
						loopGetFSCnt=0;
					}
				},1000);
			}
		}
		
		async function postJson(link,postData){
			const data = await (await (fetch('http:/'+link,
			{
			 headers: {
				'Content-Type': 'application/json'
				},
				method: 'POST',
				body: postData
			})
			.then(res => {
			  return res.json()
			})
			.catch(err => {
			  console.log('Error: ','link: '+link+' '+err)
			})
		  ))
		  return data
		}
			
		async function getJson(link){
			const data = await (await (fetch('http:/'+link)
			.then(res => {
			  return res.json()
			})
			.catch(err => {
			  console.log('Error: ', 'link: '+link+' '+err)
			})
		  ))
		  return data
		}
		

	</script>

</body>
</html>

