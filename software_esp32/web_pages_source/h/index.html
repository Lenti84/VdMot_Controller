
<!DOCTYPE html>

<html>
<head>
<link rel="icon" href="data:,">
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
	body {
	  font-family: sans-serif;
	  margin:0;
	}
	/* Add a black background color to the top navigation */
	.topNav {
		background-color: #333;
		overflow: hidden;
	}

	/* Style the links inside the navigation bar */
	.topNav a {
		float: left;
		display: block;
		color: #f2f2f2;
		text-align: center;
		padding: 14px 16px;
		text-decoration: none;
		font-size: 17px;
	}

	/* Change the color of links on hover */
	.topNav a:hover {
		background-color: #ddd;
		color: black;
	}

	/* Hide the link that should open and close the topNav on small screens */
	.topNav .icon {
		display: none;
	}

	/* When the screen is less than 600 pixels wide, hide all links, except for the first one ("Home"). Show the link that contains should open and close the topNav (.icon) */
	@media screen and (max-width: 600px) {
	  .topNav a:not(:first-child) {display: none;}
	  .topNav a.icon {
		float: right;
		display: block;
	  }
	}

	/* The "responsive" class is added to the topNav with JavaScript when the user clicks on the icon. This class makes the topNav look good on small screens (display the links vertically instead of horizontally) */
	@media screen and (max-width: 600px) {
	  .topNav.responsive {position: relative;}
	  .topNav.responsive a.icon {
		position: absolute;
		right: 0;
		top: 0;
	  }
	  .topNav.responsive a {
		float: none;
		display: block;
		text-align: left;
	  }
	}
	
	/* Style the tab content (and add height:100% for full page content) */
	.tabContent {
	  color: white;
	  display: none;
	  padding: 10px 20px;
	//  height: 100%;
	 
	}

	table.tabTable td {
		padding-left: 5px;
		height:21px;
	}
	
	
	/* Style tab links */
	.tabLink {
	  background-color: #555;
	  color: white;
	  float: left;
	  border: none;
	  outline: none;
	  cursor: pointer;
	  padding: 14px 16px;
	  font-size: 17px;
	  width: 10%;
	}

	.tabLink:hover {
	  background-color: #777;
	}
	
	.tabframe {
	  border: white 2px solid;
	  padding: 5px;
	  border-radius: 5px;
	  text-align: center;
	}
	
	.tabiframe {
	  border-top: white 1px solid;
	  padding: 5px;
	  text-align: center;
	}
	
	.form-input{
		width: 100px;
	}
	
	.rtabframe {
		width: 25%;
		display: inline-block;
		border: white 2px solid;
		padding: 5px;
		border-radius: 5px;
		text-align: center;
	}
	
	.hide {
		display: none;
	}
	
	.show {
		display: block;
		text-align: center;
		padding-left: 5px;
	}
	
   .buttonclass:hover {
		padding: 0.6em;
		font-weight: bold;
		background-color: #fff;
		color: green;
	}

	.buttonclass {
		font-weight: bold;
		background-color: #79B935;
		color: #fff;
		margin: 2px;
		padding: 0.6em;

	}
		.buttonclass:disabled {
		font-weight: bold;
		background-color: #79B900;
		color: #c0c0c0;
	}

	
	@media screen and (max-width: 500px) {
		.rtabframe,
		.rtabframe,
		.rtabframe,
		.rtabframe,
		.rtabframe {
			width: 70%;
		}
	}
	
	#Home {background-color: gray;}
	#Status {background-color: gray;}
	#Network {background-color: gray;}
	#Config {background-color: gray;}
	#Update {background-color: gray;}
	#About {background-color: gray;}

</style>

</head>
<body>

	<div class="topNav" id="mytopNav">
	  <a href="#home" class="tabLink" id="defaultOpen" onclick="openPage('Home', this, 'red')">Home</a>
	  <a href="#status" class="tabLink" onclick="openPage('Status', this, 'green')">Status</a>
	  <a href="#network" class="tabLink" onclick="openPage('Network', this, 'blue')">Network</a>
	  <a href="#config" class="tabLink" onclick="openPage('Config', this, 'gray')">Config</a>
	  <a href="#update" class="tabLink" onclick="openPage('Update', this, 'cyan')">Update</a>
	  <a href="#about" class="tabLink" onclick="openPage('About', this, 'darkgray')">About</a>
	  <a href="javascript:void(0);" class="icon" onclick="resptopNav()">&#9776;</a>
	</div>

	<div id="Home" class="tabContent">
		<div class="rtabframe" style="width: 250px;">
		<h3>VDMot Controller</h3>
		<table id="homeInfo" class="tabTable">
			<tr>
				<th>Time</th>
				<td id="locTime"></td>
			</tr>
		</table>
		</div>
		<div class="rtabframe" style="width: 250px;">
		<h3>WT32 Controller</h3>
		<table id="homeInfo" class="tabTable">
			<tr>
				<th>Version</th>
				<td id="sysWt32-Version"></td>
			</tr>
			<tr>
				<th>Heap</th>
				<td id="heap"></td>
			</tr>	
			<tr id="tr-rssi" class="hide">
				<th>RSSI</th>
				<td id="rssi"></td>
			</tr>
		</table>
		</div>
		<div class="rtabframe" style="width: 250px;">
		<h3>STM32 Controller</h3>
		<table id="homeInfo" class="tabTable">
			<tr>
				<th>Version</th>
				<td id="sysSTM32-Version"></td>
			</tr>
		</table>
		</div>
	</div>

	<div id="Status" class="tabContent">
		<div class="rtabframe" style="width: 330px;height:420px">  
		<h3>Valves</h3>	
		<table id="valvesTable" class="tabTable" border="3" frame="box" style="text-align:center">
		</table>
		</div>
		
		<div class="rtabframe" style="width: 150px;height:420px">  
		<h3>Temperature</h3>
		<table id="tempsTable" class="tabTable" border="3" frame="box" style="text-align:center">
		</table>
		</div>
	</div>

	<div id="Network" class="tabContent">
		<div class="tabframe" style="width: 250px;"> 
		<h3>Network</h3>
		<table id="netInfo" class="tabTable">
			<tr>
				<th>Eth/Wifi</th>
				<td id="net-EthWifi"></td>
			</tr>
			<tr>
				<th>DHCP</th>
				<td id="net-dhcp"></td>
			</tr>
			<tr>
				<th>IP</th>
				<td id="net-ip"></td>
			</tr>
			<tr>
				<th>MAC</th>
				<td id="net-MAC"></td>
			</tr>
			<tr>
				<th>Subnet Mask</th>
				<td id="net-mask"></td>
			</tr>
			<tr>
				<th>Gateway</th>
				<td id="net-gw"></td>
			</tr>
			<tr>
				<th>DNS</th>
				<td id="net-dns"></td>
			</tr>
		</table>
		</div>
	</div>
	
	<div id="Config" class="tabContent">
		<div class="rtabframe" style="width: 250px;">
		<h3>Network</h3>
		<table id="netConfig" class="tabTable">
		<tr>
				<th>User name</th>
				<td>
				<input type="text" maxlength="64" class="form-input" id="netcfg-UserName" name="netcfg-UserName" />
				</td>
			</tr>
			<tr>
				<th>User password</th>
				<td>
				<input type="password" maxlength="64" class="form-input" id="netcfg-UserPwd" name="netcfg-UserPwd"/>
				</td>
			</tr>
			<tr>
				<th>Re-type user password</th>
				<td>
				<input type="password" maxlength="64" class="form-input" id="netcfg-UserPwd2" name="netcfg-UserPwd2"/>
				</td>
			</tr>
			<tr>
				<th>DHCP</th>
				<td>
				<select id="netcfg-dhcp" style="width: 50px;">
                    <option>OFF</option>
                    <option>ON</option>
				</select>
				</td>
            </tr>                    
			<tr>
				<th>IP</th>
				<td>
				<input type="text" class="form-input" id="netcfg-ip" name="netcfg-ip" placeholder="xxx.xxx.xxx.xxx"/>
				</td>
			</tr>
			<tr>
				<th>Subnet Mask</th>
				<td>
				<input type="text" class="form-input" id="netcfg-mask" name="netcfg-mask" placeholder="xxx.xxx.xxx.xxx"/>
				</td>
			</tr>
			<tr>
				<th>Gateway</th>
				<td>
				<input type="text" class="form-input" id="netcfg-gw" name="netcfg-gw" placeholder="xxx.xxx.xxx.xxx"/>
				</td>
			</tr>
			<tr>
				<th>DNS</th>
				<td>
				<input type="text" class="form-input" id="netcfg-dns" name="netcfg-dns" placeholder="xxx.xxx.xxx.xxx"/>
				</td>
			</tr>
			<tr></tr>
			<tr> 
				<th>Eth/Wifi</th>
				<td>
				<select id="netcfg-EthWifi" style="width: 50px;">
					<option>Auto</option>
                    <option>Eth</option>
                    <option>Wifi</option>
				</select>
				</td>
            </tr>  
		</table>
		
		<table id="netcfg-wifi" style="display:none;" class="tabTable">
				<tr>
				<th>Wifi SSID</th>
				<td>
				<input type="text" maxlength="64" class="form-input" id="netcfg-WifiSSID" name="netcfg-WifiSSID" />
				</td>
			</tr>
			<tr>
				<th>Wifi password</th>
				<td>
				<input type="password" maxlength="64" class="form-input" id="netcfg-WifiPwd" name="netcfg-WifiPwd"/>
				</td>
			</tr>
			<tr>
				<th>Re-type wifi password</th>
				<td>
				<input type="password" maxlength="64" class="form-input" id="netcfg-WifiPwd2" name="netcfg-WifiPwd2"/>
				</td>
			</tr>
		</table>
		<tr><th></th></tr>
		<div class="tabiframe" style="width: 240px;"> 
		<table id="netcfg-time" class="tabTable">
			
			<tr><th>Time server</th></tr>
			<tr>
				<th>Name</th>
				<td>
				<input type="text" maxlength="64" class="form-input" id="netcfg-TimeServer" name="netcfg-TimeServer" />
				</td>
			</tr>
			<tr>
				<th>Time offset (s)</th>
				<td>
				<input type="number" class="form-input" id="netcfg-timeOffset" name="netcfg-timeOffset" placeholder="xxxxxx"/>
				</td>
			</tr>
			<tr>
				<th>DST offset (s)</th>
				<td>
				<input type="number" class="form-input" id="netcfg-daySTOffset" name="netcfg-daySTOffset" placeholder="xxxxxx"/>
				</td>
			</tr>
		</table>
		</div>
		
		<div class="tabiframe" style="width: 240px;"> 
		<table id="netcfg-syslog" class="tabTable">		
			<tr>
				<th>Syslog server</th>
				<td>
				<select id="netcfg-syslog-select">
                    <option>Off</option>
                    <option>Small</option>
					<option>Detail</option>
                    <option>Atomic</option>
				</select>
				</td>
            </tr> 
		</table>
		<table id="netcfg-syslog-table" style="display:none;" class="tabTable">
				<tr>
				<th>Client IP</th>
				<td>
				<input type="text" class="form-input" id="netcfg-syslog-ip" name="netcfg-syslog-ip" placeholder="xxx.xxx.xxx.xxx"/>
				</td>
			</tr>
			<tr>
				<th>Port</th>
				<td>
				<input type="text" class="form-input" id="netcfg-syslog-port" name="netcfg-syslog-port" placeholder="xxxx"/>
				</td>
			</tr>

		</table>
		</div>
		
		</div>
				
		<div class="rtabframe" style="width: 250px;">
		<h3>Protocol</h3>

		<table id="protConfig" class="tabTable">		
			<tr>
				<th>Data protocol</th>
				<td>
				<select id="protcfg-dataProt">
                    <option>none</option>
                    <option>MQTT</option>
				</select>
				</td>
            </tr> 
		</table>
		<table id="protcfg-mqtt" style="display:none;" class="tabTable">
				<tr>
				<th>Broker IP</th>
				<td>
				<input type="text" class="form-input" id="protcfg-mqttIp" name="protcfg-mqttIp" placeholder="xxx.xxx.xxx.xxx"/>
				</td>
			</tr>
			<tr>
				<th>Broker Port</th>
				<td>
				<input type="text" class="form-input" id="protcfg-mqttPort" name="protcfg-mqttPort" placeholder="xxxx"/>
				</td>
			</tr>

		</table>
		</div>

		<div class="rtabframe" style="width: 220px;">
		<h3>Valves</h3>
		<table id="cfgValvesTable" class="tabTable" border="3" frame="box" style="text-align:center">
		</table>
		
		<div class="tabiframe" style="width: 210px;">	
		<table id="cfgValvesTable1" class="tabTable"
			<tr><th>Calibration</th></tr>
			<tr>
				<th>Day</th>
				<td>
				<select id="vCfg-dCalib">
                    <option>Sunday</option>
                    <option>Monday</option>
					<option>Tuesday</option>
					<option>Wednesday</option>
					<option>Thursday</option>
					<option>Friday</option>
					<option>Saturday</option>
				</select>
				</td>
            </tr> 
			<tr>
				<th>Hour</th>
				<td>
				<input type="number" max="24" min="0" maxlength="2" size="2" id="vCfg-hCalib" name="vCfg-hCalib"/>
				</td>
			</tr>
			</table>
			<table id="cfgValvesTable2" class="tabTable"
			<tr>
				<td>
                <input type="button" class="buttonclass" id="valvesStartCalib" value="Start calibration" title="Start manual calibration of all valves" />
                </td>
			</tr>
			</table>
		</div>
		</div>
		
		<div class="rtabframe" style="width: 310px;">
		<h3>Temperature sensor</h3>
		<table id="cfgTSensorTable" class="tabTable" border="3" frame="box" style="text-align:center">
			
		</table>
		</div>
		
		<div class="rtabframe" style="width: 250px;">
		<h3>System</h3>
		<table id="sysConfig" class="tabTable">
			<tr>
				<td>
                <input type="button" class="buttonclass" id="sysReboot" value="Reboot system" title="Reboot system" />
                </td>
			</tr>
			<tr>
                <td>
                <input type="button" class="buttonclass" id="saveConfig" value="Save config" title="Save all settings."/>
                </td>
            </tr>
			<tr></tr>
			<tr>
                <td>
                <input type="button" class="buttonclass" id="factoryRestore" value="Restore factory default settings" title="Reset config including network settings."/>
                </td>
            </tr>
			<tr>
				<td>
                <input type="button" class="buttonclass" id="resetConfig" value="Reset config" title="Reset config excluding network settings." />
                </td>
			</tr>	
		</table>
		</div>
		
	</div>
	
	<div id="Update" class="tabContent">
		<div class="rtabframe" style="width: 250px;">
		<h3>Update</h3>
		<table id="sysUpdate" class="tabTable">
			<tr>
				<td>
                <input type="button" class="buttonclass" id="update-WT32" value="Update WT32" title="Update WT32" />
                </td>
			</tr>
			<tr>
				<td>
                <input type="button" class="buttonclass" id="update-STM32" value="Update STM32" title="Update WT32" />
                </td>
			</tr>
		</table>
		</div>
	</div>
	
	<div id="About" class="tabContent">
		<div class="tabframe" style="width: 450px;">
		<h3>About this VDMot controller</h3>
		<table id="aboutInfo" class="tabTable">
		<p> 
		THIS SOFTWARE IS PROVIDED "AS IS" AND ANY EXPRESSED OR
		IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
		OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
		IN NO EVENT SHALL THE DEVELOPER OR ANY CONTRIBUTORS BE LIABLE FOR ANY DIRECT,
		INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
		(INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
		SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
		HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,
		STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING
		IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF
		THE POSSIBILITY OF SUCH DAMAGE. 
		</p>
		<p> 	
		This program is free software: you can redistribute it and/or modify
		it under the terms of the GNU General Public License as published by
		the Free Software Foundation, either version 3 of the License.
		</p>
		<p> 
		See the GNU General Public License for more details.

		You should have received a copy of the GNU General Public License
		along with this program.  If not, see http://www.gnu.org/licenses/.
		</p>
		<p>
		Copyright (C) 2021 Lenti84  https://github.com/Lenti84/VdMot_Controller
		</p>	
		<p>
		Contributor : SurfGargano
		</p>
		</table>
		</div>
	</div>

	<script>		
				
		var WifiPwdHasChanged=false;
		var UserPwdHasChanged=false;			
				
		/* Toggle between adding and removing the "responsive" class to topNav when the user clicks on the icon */
		function resptopNav() {
			var x = document.getElementById("mytopNav");
			if (x.className === "topNav") {
				x.className += " responsive";
			} else {
				x.className = "topNav";
			}
		}
		function openPage(pageName,elmnt,color) {
		  var i, tabContent, tabLinks;
		  tabContent = document.getElementsByClassName("tabContent");
		  for (i = 0; i < tabContent.length; i++) {
			tabContent[i].style.display = "none";
		  }
		  tabLinks = document.getElementsByClassName("tabLink");
		  for (i = 0; i < tabLinks.length; i++) {
			tabLinks[i].style.backgroundColor = "";
		  }
		  document.getElementById(pageName).style.display = "block";
		  elmnt.style.backgroundColor = color;
		}
					
				
		// Get the element with id="defaultOpen" and click on it
		document.getElementById("defaultOpen").click();
		
		var id = function(elid) {
					var ret = document.getElementById(elid);
                    if(!ret){
                        console.log('No element found with id ' + elid);
                    }
                    return ret;
                };
				
				
		OnStart();
		
		function OnStart() {
			makeValvesTable();
			makeTempsTable();
			makeCfgValvesTable();
			makeCfgTempTable();
			getSystemInfo();
			getSystemDynInfo();
			getNetInfo();
			getNetConfig();
			getProtConfig();
			getValvesConfig();
			getTempsConfig();
			getValvesStatus();
			getTempsStatus();
			var getStatusInterval = window.setInterval(getStatus, 5000);
			generateOnClick();
		}		
				
		function ValidateIPaddress(inputText) {
			var ipformat = /^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;
			if (inputText.value.match(ipformat)) {
			  document.form1.text1.focus();
			  return true;
			} else {
			  alert("You have entered an invalid IP address!");
			  document.form1.text1.focus();
			  return false;
			}
		}
		
		function makeValvesTable() {
			var ValvesTable = document.getElementById('valvesTable');	  
			for (var row=0; row<13; row++) { 
				const thisRow = valvesTable.insertRow(0);
				for (var i = 0; i < 6; i++) {
					cell = thisRow.insertCell();
					//cell.innerHTML = '--';	
				}
			}
			for (row=1;row<13;row++) {
				var thiscell = ValvesTable.rows[row].cells[4];
				var el = document.createElement('input');
				el.setAttribute('type', 'number');
				el.setAttribute('name', 'setValveP' + row);
				el.setAttribute('id', 'setValveP' + row);
				el.setAttribute('size', '3');
				el.setAttribute('maxlength' , '3');
				el.setAttribute('min' , '0');
				el.setAttribute('max' , '100');
				el.setAttribute('style','height:15px');
				el.setAttribute('readonly','true');
				thiscell.appendChild(el);
				var thiscell = ValvesTable.rows[row].cells[5];
				var el = document.createElement('input');
				el.setAttribute('type', 'button');
				el.setAttribute('name', 'setValveButton' + row);
				el.setAttribute('id', 'setValveButton' + row);
				el.setAttribute('style','height:20px;width:35px;visibility:hidden;');
				el.setAttribute('value', 'Set');
				thiscell.appendChild(el);
				valvesTable.rows[row].cells[0].innerHTML = row;
			}
			valvesTable.rows[0].cells[0].textContent = 'No';
			valvesTable.rows[0].cells[1].textContent = 'Name';
			valvesTable.rows[0].cells[2].textContent = '%';
			valvesTable.rows[0].cells[3].textContent = 'mA';
			var thiscell = ValvesTable.rows[0].cells[4];
			var el = document.createElement('input');
			el.setAttribute('type', 'checkbox');
			el.setAttribute('name', 'activeSetValves');
			el.setAttribute('id', 'activeSetValves');
			valvesTable.rows[0].cells[4].innerHTML = 'Target %';
			thiscell.appendChild(el);
		}
		
		function makeTempsTable() {
			var tempsTable = document.getElementById('tempsTable');	  
			for (var row=0; row<13; row++) { 
				const thisRow = tempsTable.insertRow(0);
				
				for (var i = 0; i < 3; i++) {
					cell = thisRow.insertCell();
					cell.innerHTML = '--';	
				}
			}
			for (row=1;row<13;row++) tempsTable.rows[row].cells[0].innerHTML = row;
			tempsTable.rows[0].cells[0].textContent = 'No';
			tempsTable.rows[0].cells[1].textContent = 'Name';
			tempsTable.rows[0].cells[2].textContent = 'C';
		}
		
		function makeCfgValvesTable() {
			var cfgValvesTable = document.getElementById('cfgValvesTable');	  
			for (var row=0; row<13; row++) { 
				const thisRow = cfgValvesTable.insertRow(0);
				for (var i = 0; i < 3; i++) {
					cell = thisRow.insertCell();
				}
			}
			for (row=1;row<13;row++) cfgValvesTable.rows[row].cells[0].innerHTML = row;
			for (row=1;row<13;row++) {
				var thiscell = cfgValvesTable.rows[row].cells[1];
				var el = document.createElement('input');
				el.setAttribute('type', 'text');
				el.setAttribute('name', 'cfgVName' + row);
				el.setAttribute('id', 'cfgVName' + row);
				el.setAttribute('size', '10');
				el.setAttribute('maxlength' , '10');
				thiscell.appendChild(el);
				var thiscell = cfgValvesTable.rows[row].cells[2];
				var elc = document.createElement('input');
				elc.setAttribute('type', 'checkbox');
				elc.setAttribute('name', 'cfgVActive' + row);
				elc.setAttribute('id', 'cfgVActive' + row);
				thiscell.appendChild(elc);
				
			}
			cfgValvesTable.rows[0].cells[0].textContent = 'No';
			cfgValvesTable.rows[0].cells[1].textContent = 'Name';
			cfgValvesTable.rows[0].cells[2].textContent = 'Active';
		}
		
		function makeCfgTempTable() {
			var cfgTempTable = document.getElementById('cfgTSensorTable');	  
			for (var row=0; row<13; row++) { 
				const thisRow = cfgTempTable.insertRow(0);
				for (var i = 0; i < 4; i++) {
					cell = thisRow.insertCell();
				}
			}
			for (row=1;row<13;row++) cfgTempTable.rows[row].cells[0].innerHTML = row;
			for (row=1;row<13;row++) {
				var thiscell = cfgTempTable.rows[row].cells[1];
				var el = document.createElement('input');
				el.setAttribute('type', 'text');
				el.setAttribute('name', 'cfgTName' + row);
				el.setAttribute('id', 'cfgTName' + row);
				el.setAttribute('size', '10');
				el.setAttribute('maxlength' , '10');
				thiscell.appendChild(el);
				var thiscell = cfgTempTable.rows[row].cells[2];
				var elc = document.createElement('input');
				elc.setAttribute('type', 'checkbox');
				elc.setAttribute('name', 'cfgTActive' + row);
				elc.setAttribute('id', 'cfgTActive' + row);
				thiscell.appendChild(elc);
				var thiscell = cfgTempTable.rows[row].cells[3];
				var el = document.createElement('input');
				el.setAttribute('type', 'text');
				el.setAttribute('name', 'cfgTOffset' + row);
				el.setAttribute('id', 'cfgTOffset' + row);
				el.setAttribute('size', '4');
				el.setAttribute('maxlength' , '4');
				thiscell.appendChild(el);
			}
			cfgTempTable.rows[0].cells[0].textContent = 'No';
			cfgTempTable.rows[0].cells[1].textContent = 'Name';
			cfgTempTable.rows[0].cells[2].textContent = 'Active';
			cfgTempTable.rows[0].cells[3].textContent = 'Offset';
		}
		
		function showMqttIP(){
			var x = id("protcfg-mqtt");
			var select = id("protcfg-dataProt").selectedIndex;
			if (select === 0) {
				x.style.display = "none";
			} else {
				x.style.display = "block";
			}
		}
		
		function showWifi(){
			var x = id("netcfg-wifi");
			var e = id("tr-rssi");
			var select = id("netcfg-EthWifi").selectedIndex;
			if (select === 1) {
				x.style.display = "none";
				e.style.display = "none";
			} else {
				x.style.display = "block";
				e.className = 'show';
			}
		}
		
		function showSyslogIP(){
			var x = id("netcfg-syslog-table");
			var select = id("netcfg-syslog-select").selectedIndex;
			if (select === 0) {
				x.style.display = "none";
			} else {
				x.style.display = "block";
			}
		}
		
			
		function generateOnClick() {
			id("netcfg-EthWifi").onclick = function(){
				showWifi();
			}
			id("netcfg-syslog-select").onclick = function(){
				showSyslogIP();
			}
			id("protcfg-dataProt").onclick = function(){
			  showMqttIP();
			}
			id("valvesStartCalib").onclick = function(){
				valvesStartCalib();
			};
			id("factoryRestore").onclick = function(){
				factoryRestore();
			};
			id("resetConfig").onclick = function(){
				resetConfig();
			};
			id("sysReboot").onclick = function(){
				reboot();
			};
			id("saveConfig").onclick = function(){
				saveConfig();
			};
			id("update-WT32").onclick = function(){
				updateWT32();
			};
			id("update-STM32").onclick = function(){
				updateSTM32();
			};
			
			id("netcfg-WifiPwd").onchange = function(){
				WifiPwdHasChanged=true;
			};
			
			id("activeSetValves").onclick = function(){
				activateSetValves();
			};
			
			
			for (var i=1; i<13;i++) { 
				generateOnValveClick(i);
			}
		}
		
		function generateOnValveClick (nr) {
			var el = id("setValveButton" + nr);
				el.onclick = function () {
					setValve(nr);
				}
		}
		
		function activateSetValves(){
			var checked=id("activeSetValves").checked ;
			console.log (checked);
			for (i=1; i<13;i++){
				id('setValveP'+i).readOnly=!checked;
				if (checked) 
					id('setValveButton'+i).style.visibility="visible"
				else
					id('setValveButton'+i).style.visibility="hidden";
			}
		}
		
		function valvesStartCalib(){
			if (confirm('Are you sure you want to start calibration of all valves ?')) {
				postCmd('{"action":"vCalib"}');
			}
		}

		function factoryRestore(){
			if (confirm('Are you sure you want to restore configuration to factory settings ?')) {
				postCmd('{"action":"restoreCfg"}');
				setTimeout(function() {window.reload();},1000);
			}
		}
		
		function resetConfig(){
			if (confirm('Are you sure you want to reset configuration to factory settings except network ?')) {
				postCmd('{"action":"resetCfg"}');
				setTimeout(function() {window.reload();},1000);
			}
		}
		
		function reboot(){
			if (confirm('Are you sure you want to reboot ?')) {
				postCmd('{"action":"reboot"}');
				setTimeout(function() {window.reload();},1000);
			}
		}
			
		async function saveConfig(){
			if (confirm('Are you sure you want to save configuration ?')) {
				await postNetCfg();
				await postProtCfg();
				await postValvesCfg();
				await postTempsCfg();
				await postCmd('{"action":"saveCfg"}');
				WifiPwdHasChanged=false;
				UserPwdHasChanged=false;
				setTimeout(function() {window.reload();},1000);
			}
		}
		
		async function postNetCfg() {
			var netCfg = {};
			netCfg.ethWifi = id("netcfg-EthWifi").selectedIndex;
			netCfg.dhcp = id("netcfg-dhcp").selectedIndex;
			netCfg.ip =	id("netcfg-ip").value;
			netCfg.mask = id("netcfg-mask").value;
			netCfg.gw =	id("netcfg-gw").value;
			netCfg.dns = id("netcfg-dns").value;
			netCfg.ssid = id("netcfg-WifiSSID").value;
			if (WifiPwdHasChanged===true) {
				netCfg.pwd = id("netcfg-WifiPwd").value;
				if (id("netcfg-WifiPwd").value!=id("netcfg-WifiPwd2").value) {
					alert ("Wifi password does not compare ! Please re-type");
					return;
				}
			}
			netCfg.userName = id("netcfg-UserName").value;
			if (UserPwdHasChanged===true) {
				netCfg.Userpwd = id("netcfg-UserPwd").value;
				if (id("netcfg-UserPwd").value!=id("netcfg-UserPwd2").value) {
					alert ("User password does not compare ! Please re-type");
					return;
				}
			}
			netCfg.timeServer = id("netcfg-TimeServer").value;
			netCfg.timeOffset =	parseInt(id("netcfg-timeOffset").value);
			netCfg.timeDST = parseInt(id("netcfg-daySTOffset").value);
			netCfg.syslogLevel=id("netcfg-syslog-select").selectedIndex;
			netCfg.syslogIp=id("netcfg-syslog-ip").value;
			netCfg.syslogPort=id("netcfg-syslog-port").value;
			await postJson("netconfig",JSON.stringify(netCfg));
		}
		
		async function postProtCfg() {
			var protCfg = {};
			protCfg.prot = id("protcfg-dataProt").selectedIndex;
			if (id("protcfg-dataProt").selectedIndex==1) {
				protCfg.mqttIp = id("protcfg-mqttIp").value;
				protCfg.mqttPort = id("protcfg-mqttPort").value;
			}
			await postJson("protconfig",JSON.stringify(protCfg));
		}
		
		async function postValvesCfg() {
			var cfgValvesTable = id('cfgValvesTable');
			var valvesItemsCfg = [];
			for (var row = 1; row<13; row++) {
				var valveValues={};
				valveValues.name = id('cfgVName'+row).value; 
				valveValues.active = id('cfgVActive'+row).checked  ? 1 : 0;
				valvesItemsCfg.push(valveValues);
			}
			var valvesCfg={};
			var valvesCalib={};
			valvesCalib.dayOfCalib=id('vCfg-dCalib').selectedIndex;
			valvesCalib.hourOfCalib=id('vCfg-hCalib').value;
			valvesCfg.calib=valvesCalib;
			valvesCfg.valves=valvesItemsCfg;
			await postJson("valvesconfig",JSON.stringify(valvesCfg));
		}
				
		async function postTempsCfg() {
			var cfgTempsTable = id('cfgTSensorTable');
			var tempsItemsCfg = [];
			for (var row = 1; row<13; row++) {
				var tempValues={};
				tempValues.name = id('cfgTName'+row).value; 
				tempValues.active = id('cfgTActive'+row).checked  ? 1 : 0;
				var f = id('cfgTOffset'+row).value.replace(/ /g, "");
				f  = f.replace(/,/g, '.');
				f = parseFloat(f).toFixed(1)
				tempValues.offset = parseFloat(f);
				tempsItemsCfg.push(tempValues);
			}
			var tempsCfg={};
			tempsCfg.temps=tempsItemsCfg;
			await postJson("tempsconfig",JSON.stringify(tempsCfg));
		}
		
		async function postCmd (cmd) {
			await postJson("cmd",cmd);
		}
		
		async function setValve(valveNo){
			var value = id('setValveP'+valveNo).value;
			if (value){
				var setThisValve = {};
				setThisValve.valve = valveNo;
				setThisValve.value = value;
				await postJson("setvalve",JSON.stringify(setThisValve));
			}
		}
				
		function getStatus() {
			getSystemDynInfo();
			getValvesStatus();
			getTempsStatus();
		}
		
		function fillValvesTable (valvesJson) {
			var ValvesTable = document.getElementById('valvesTable');
			for (var row = 1; row<13; row++) {	
				ValvesTable.rows[row].cells[2].textContent = valvesJson[row-1].pos;	
				ValvesTable.rows[row].cells[3].textContent = valvesJson[row-1].meanCur;
				if (!(id('activeSetValves').checked)) {
					id('setValveP'+row).value=valvesJson[row-1].targetPos;
				}
			}
		}
		
		function fillCfgValvesTable (cfgValvesJson) {
			var ValvesTable = document.getElementById('valvesTable');
			var cfgValvesTable = document.getElementById('cfgValvesTable');
			for (var row = 1; row<13; row++) {
				ValvesTable.rows[row].cells[1].textContent = cfgValvesJson.valves[row-1].name;
				id('cfgVName'+row).value = cfgValvesJson.valves[row-1].name;
				id('cfgVActive'+row).checked = cfgValvesJson.valves[row-1].active;
			}
			id('vCfg-dCalib').selectedIndex = cfgValvesJson.calib.dayOfCalib;
			id('vCfg-hCalib').value = cfgValvesJson.calib.hourOfCalib;
		}
		
		function fillTempsTable (tempsJson) {
			var tempsTable = document.getElementById('tempsTable');
			for (var row = 1; row<13; row++) {		
				tempsTable.rows[row].cells[2].textContent = tempsJson[row-1].temp;
			}
		}
		
		function fillCfgTempsTable (cfgTempsJson) {
			var tempsTable = document.getElementById('tempsTable');
			var cfgTempsTable = document.getElementById('cfgTSensorTable');
			for (var row = 1; row<13; row++) {				
				tempsTable.rows[row].cells[1].textContent = cfgTempsJson[row-1].name;
				id('cfgTName'+row).value = cfgTempsJson[row-1].name;
				id('cfgTActive'+row).checked = cfgTempsJson[row-1].active;
				id('cfgTOffset'+row).value = cfgTempsJson[row-1].offset;
			}
		}
		
		async function getSystemInfo() {
			var dataSystemInfo=await getJson("sysinfo");
			if (dataSystemInfo) {
				id("sysWt32-Version").textContent = dataSystemInfo["wt32version"];
				
			}
		}
		
		async function getSystemDynInfo() {
			var dataSystemDynInfo=await getJson("sysdyninfo");
			if (dataSystemDynInfo) {
				id("locTime").textContent = dataSystemDynInfo["locTime"];
				id("heap").textContent = dataSystemDynInfo["heap"];
				id("rssi").textContent = dataSystemDynInfo["wifirssi"];
			}
		}
		
		
		async function getNetInfo() {
			var dataNet=await getJson("netinfo");
			if (dataNet) {
				id("net-EthWifi").textContent = dataNet["ethWifi"] ? "Wifi" : "Eth";
				id("net-dhcp").textContent = dataNet["dhcp"] ? "On" : "Off";
				id("net-ip").textContent = dataNet["ip"];
				id("net-MAC").textContent = dataNet["mac"];
				id("net-mask").textContent = dataNet["mask"];
				id("net-gw").textContent = dataNet["gw"];
				id("net-dns").textContent = dataNet["dns"];
			}
		}
		
		async function getNetConfig() {
			var dataNetConfig=await getJson("netconfig");
			if (dataNetConfig) {
				id("netcfg-EthWifi").selectedIndex = dataNetConfig["ethWifi"];
				id("netcfg-dhcp").selectedIndex = dataNetConfig["dhcp"];
				id("netcfg-ip").value = dataNetConfig["ip"];
				id("netcfg-mask").value = dataNetConfig["mask"];
				id("netcfg-gw").value = dataNetConfig["gw"];
				id("netcfg-dns").value = dataNetConfig["dns"];
				id("netcfg-WifiSSID").value = dataNetConfig["ssid"];
				id("netcfg-UserName").value = dataNetConfig["userName"];
				id("netcfg-TimeServer").value = dataNetConfig["timeServer"];
				id("netcfg-timeOffset").value = dataNetConfig["timeOffset"];
				id("netcfg-daySTOffset").value = dataNetConfig["timeDST"];
				id("netcfg-syslog-select").selectedIndex=dataNetConfig.syslogLevel;
				id("netcfg-syslog-ip").value=dataNetConfig.syslogIp;
				id("netcfg-syslog-port").value=dataNetConfig.syslogPort;
				showWifi();
				showSyslogIP();
			}
		}
		
		async function getProtConfig() {
			var dataProtConfig=await getJson("protconfig");
			if (dataProtConfig) {
				id("protcfg-dataProt").selectedIndex = dataProtConfig["prot"];
				id("protcfg-mqttIp").value = dataProtConfig["mqttIp"];
				id("protcfg-mqttPort").value = dataProtConfig["mqttPort"];
				showMqttIP();
			}
		}
		
		async function getValvesConfig() {
			var dataValvesConfig=await getJson("valvesconfig");
			if (dataValvesConfig) fillCfgValvesTable(dataValvesConfig);
		}
		
		async function getValvesStatus() {
			var dataValvesStatus=await getJson("valves");
			if (dataValvesStatus) fillValvesTable(dataValvesStatus);
		}
		
		async function getTempsConfig() {
			var dataTempsConfig=await getJson("tempsconfig");
			if (dataTempsConfig) fillCfgTempsTable(dataTempsConfig);
		}
		
		async function getTempsStatus() {
			var dataTempsStatus=await getJson("temps");
			if (dataTempsStatus) fillTempsTable(dataTempsStatus);
		}
			
		async function updateWT32() {
			location.assign('http:/update');
			location.replace('http:/update');
			window.reload();
		}	
		
		async function updateSTM32() {
			location.assign('http:/stmupdate');
			location.replace('http:/stmupdate');
			window.reload();
		}	
			
		async function postJson(link,postData){
			let data = await (await (fetch('http:/'+link,
			{
			 headers: {
				'Content-Type': 'application/json'
				},
				method: 'POST',
				body: postData
			})
			.then(res => {
			  console.log(res);
			  return res
			})
			.catch(err => {
			  console.log('Error: ','link: '+link+' '+err)
			})
		  ))
		  console.log(data);
		  return data
		}
			
		async function getJson(link){
			let data = await (await (fetch('http:/'+link)
			.then(res => {
			  return res.json()
			})
			.catch(err => {
			  console.log('Error: ', 'link: '+link+' '+err)
			})
		  ))
		  return data
		}
		

	</script>

</body>
</html>

